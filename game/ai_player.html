<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.7.0"/>
    <title>game.ai_player API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../game.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;game</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#AIPlayer">AIPlayer</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#AIPlayer.__init__">AIPlayer</a>
                        </li>
                        <li>
                                <a class="variable" href="#AIPlayer.GAME_CONTEXT">GAME_CONTEXT</a>
                        </li>
                        <li>
                                <a class="variable" href="#AIPlayer.model">model</a>
                        </li>
                        <li>
                                <a class="variable" href="#AIPlayer.max_retries">max_retries</a>
                        </li>
                        <li>
                                <a class="variable" href="#AIPlayer.retry_delay">retry_delay</a>
                        </li>
                        <li>
                                <a class="function" href="#AIPlayer.get_action">get_action</a>
                        </li>
                        <li>
                                <a class="function" href="#AIPlayer.set_model">set_model</a>
                        </li>
                        <li>
                                <a class="function" href="#AIPlayer.choose_card_from_discard">choose_card_from_discard</a>
                        </li>
                        <li>
                                <a class="function" href="#AIPlayer.choose_two_cards_from_hand">choose_two_cards_from_hand</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../game.html">game</a><wbr>.ai_player    </h1>

                        <div class="docstring"><p>AI player module for the Cuttle card game.</p>

<p>This module provides the AIPlayer class that uses the Ollama language model
to make strategic decisions in the game. The AI player understands game rules,
implements strategies, and makes decisions based on the current game state.</p>
</div>

                        <input id="mod-ai_player-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-ai_player-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="sd">AI player module for the Cuttle card game.</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="sd">This module provides the AIPlayer class that uses the Ollama language model</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">to make strategic decisions in the game. The AI player understands game rules,</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">implements strategies, and makes decisions based on the current game state.</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">ollama</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">game.action</span><span class="w"> </span><span class="kn">import</span> <span class="n">Action</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">game.card</span><span class="w"> </span><span class="kn">import</span> <span class="n">Card</span><span class="p">,</span> <span class="n">Purpose</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">game.game_state</span><span class="w"> </span><span class="kn">import</span> <span class="n">GameState</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">game.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_print</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="k">class</span><span class="w"> </span><span class="nc">AIPlayer</span><span class="p">:</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;AI player that uses Ollama LLM to make decisions in the game.</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">    This class implements an AI player that uses a large language model (LLM)</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">    to analyze game states and make strategic decisions. It understands game rules,</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">    implements various strategies, and tries to avoid common mistakes.</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">    The AI player can:</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">    - Analyze the current game state</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">    - Choose optimal actions from available legal moves</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">    - Make strategic decisions about card usage</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">    - Handle special card effects and combinations</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">    Attributes:</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">        model (str): The Ollama model to use for decision making.</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">        max_retries (int): Maximum number of retries for failed LLM calls.</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">        retry_delay (int): Delay in seconds between retries.</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">        GAME_CONTEXT (str): Detailed game rules and strategy guide for the LLM.</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>    <span class="c1"># Game rules and strategy context for the LLM</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>    <span class="n">GAME_CONTEXT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="s2">You are an expert of playing competitive card games. You excel at reasoning through the rules of the card game and making optimal decisions. You are great at identifying patterns and making strategic moves. You are playing a card game called Cuttle. Here are the key rules and strategies:</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="s2">Rules:</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="s2">1. Win condition: Reach your point target (initial target is 21 points)</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="s2">2. Card Actions:</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="s2">    - Play as points (number cards 1-10), only Ace through Ten are counted as points. Eight played as face card is not counted as points.</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="s2">    - Play as face cards (Kings, Queens, Jacks, Eights)</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="s2">    - Play as one-off effects (Aces, Threes, Fours, Fives, Sixes)</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="s2">        - Aces clears all point cards for both players</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="s2">        - Threes let&#39;s you choose a card from the scrap pile. Avoid playing Threes as one-off when the scrap pile is empty or does not have any cards you want.</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="s2">        - Fives will let you draw the top two cards from the deck.</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="s2">        - Sixes clears all face cards for both players</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="s2">    - Scuttle: Play a higher point card to destroy opponent&#39;s point card</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="s2">    - Counter: Use a Two to counter any one-off effect</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="s2">3. Kings reduce your target score (1 King: 14, 2 Kings: 10, 3 Kings: 5, 4 Kings: 0)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="s2">4. Face cards provide special abilities. Face cards are not counted as points.</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="s2">    - King: Reduces target score</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="s2">    - Queen: Protects your points from face cards, certain targeted one-offs, and counters. Does not protect against Ace One-offs or Six One-offs.</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="s2">    - Jack: Steals opponent&#39;s points</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="s2">    - Eight: Glasses (opponent plays with revealed hand)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="s2">Strategies:</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="s2">1. Optimize to increase your score and decrease your target score. If you have a high value point card, try to play it as points. If a move increases your score to meet or exceed your target score, do it straight away.</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="s2">2. Prioritize playing Kings early to reduce your target score</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="s2">3. Save Twos for countering important one-off effects. Favor drawing a card over playing a two as points.</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="s2">4. Use Jacks to steal high-value point cards</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="s2">5. Protect high-value points with Queens</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="s2">6. Use Aces to clear opponent&#39;s strong point cards. Avoid playing Aces as one-off when opponent doesn&#39;t have any point cards on field. Avoid playing Aces as points when possible since the reward is low.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="s2">7. Keep track of used Twos to know when one-offs are safe</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="s2">8. Scuttle opponent&#39;s high-value points when possible</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="s2">9. Avoid playing Six as one-off when opponent doesn&#39;t have any face cards on field.</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="s2">10. If opponent score is close to opponent&#39;s target, try to play Aces as one-off to clear their points, or play Sixes as one-off to clear their Kings if any are on field.</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="s2">Mistakes to avoid:</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="s2">1. Playing Aces as one-off when opponent doesn&#39;t have any point cards on field.</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="s2">2. Playing Aces as points since the reward is low.</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="s2">3. Playing Threes as one-off when the scrap pile is empty or does not have any cards you want.</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="s2">4. Playing Sixes as one-off when opponent doesn&#39;t have any face cards on field.</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="s2">The Strategy is key to winning the game.</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="s2">    &quot;&quot;&quot;</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retry_delay</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the AI player.</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">        Sets up:</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">        - The default language model (gemma3:4b)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">        - Retry settings for LLM calls</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">        - Verifies AI&#39;s understanding of game rules</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;gemma3:4b&quot;</span>  <span class="c1"># Default to mistral model</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span> <span class="o">=</span> <span class="n">retry_delay</span>  <span class="c1"># seconds</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>        <span class="c1"># Initialize system context and verify AI understanding</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_ai_understanding</span><span class="p">()</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_verify_ai_understanding</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify that the AI understands the game rules and strategies.</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">        This method sends a test prompt to the LLM to confirm it understands</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">        the game rules and strategies. The response is logged for debugging.</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">        Note:</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">            If verification fails, a warning is logged but the AI can still function.</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>        <span class="n">verification_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Please confirm that you understand the game rules and strategies for Cuttle.</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="s2">Respond with a brief summary of your understanding and confirm that you will avoid the common mistakes listed.</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="s2">Keep your response concise.&quot;&quot;&quot;</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">ollama</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>                <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>                    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">GAME_CONTEXT</span><span class="p">},</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>                    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">verification_prompt</span><span class="p">},</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>                <span class="p">],</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>            <span class="p">)</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>            <span class="n">log_print</span><span class="p">(</span><span class="s2">&quot;AI Understanding Verification:&quot;</span><span class="p">)</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>            <span class="n">log_print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>            <span class="n">log_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not verify AI understanding: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_format_game_state</span><span class="p">(</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>        <span class="n">game_state</span><span class="p">:</span> <span class="n">GameState</span><span class="p">,</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>        <span class="n">legal_actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">],</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>        <span class="n">is_human_view</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format the current game state and legal actions into a prompt for the LLM.</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">        This method creates a detailed prompt that includes:</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="sd">        - Current state of both players (hand, field, score, target)</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a><span class="sd">        - Deck and discard pile information</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">        - List of legal actions</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">        - Instructions for the LLM</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">        Args:</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">            game_state (GameState): The current state of the game.</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">            legal_actions (List[Action]): List of legal actions available.</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="sd">            is_human_view (bool, optional): Whether to hide AI&#39;s hand. Defaults to False.</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">        Returns:</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">            str: Formatted prompt string for the LLM.</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="n">opponent</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>        <span class="n">opponent_point_cards</span> <span class="o">=</span> <span class="n">game_state</span><span class="o">.</span><span class="n">player_point_cards</span><span class="p">(</span><span class="n">opponent</span><span class="p">)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>        <span class="n">opponent_face_cards</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>            <span class="n">card</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>            <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">game_state</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">purpose</span> <span class="o">==</span> <span class="n">Purpose</span><span class="o">.</span><span class="n">FACE_CARD</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>        <span class="p">]</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>        <span class="n">legal_actions_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;- action </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">legal_actions</span><span class="p">)]</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>        <span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a><span class="s2">Current Game State:</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a><span class="s2">AI</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="si">{</span><span class="s2">&quot;AI Hand: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">game_state</span><span class="o">.</span><span class="n">hands</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">is_human_view</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;AI Hand: [Hidden]&quot;</span><span class="si">}</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="s2">AI Field: </span><span class="si">{</span><span class="n">game_state</span><span class="o">.</span><span class="n">get_player_field</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a><span class="s2">AI Score: </span><span class="si">{</span><span class="n">game_state</span><span class="o">.</span><span class="n">get_player_score</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a><span class="s2">AI Target: </span><span class="si">{</span><span class="n">game_state</span><span class="o">.</span><span class="n">get_player_target</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a><span class="s2">Opponent</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="s2">Opponent&#39;s Hand Size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">game_state</span><span class="o">.</span><span class="n">hands</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a><span class="s2">Opponent&#39;s Field: </span><span class="si">{</span><span class="n">game_state</span><span class="o">.</span><span class="n">get_player_field</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="s2">Opponent&#39;s Point Cards: </span><span class="si">{</span><span class="n">opponent_point_cards</span><span class="si">}</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a><span class="s2">Opponent&#39;s Face Cards: </span><span class="si">{</span><span class="n">opponent_face_cards</span><span class="si">}</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a><span class="s2">Opponent&#39;s Score: </span><span class="si">{</span><span class="n">game_state</span><span class="o">.</span><span class="n">get_player_score</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="s2">Opponent&#39;s Target: </span><span class="si">{</span><span class="n">game_state</span><span class="o">.</span><span class="n">get_player_target</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="s2">Deck Size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">game_state</span><span class="o">.</span><span class="n">deck</span><span class="p">)</span><span class="si">}</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="s2">Discard Pile Size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">game_state</span><span class="o">.</span><span class="n">discard_pile</span><span class="p">)</span><span class="si">}</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a><span class="s2">Legal Actions:</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a><span class="si">{</span><span class="n">legal_actions_str</span><span class="si">}</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a><span class="s2">Instructions:</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="s2">1. Analyze the game state and available actions. What is opponent&#39;s score and target? What is your score and target?</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a><span class="s2">2. Choose the best action among the legal actions based on the game rules and strategies, think through the consequences of your actions and a few turns ahead. Avoid making mistakes that will cost you the game.</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a><span class="s2">3. IMPORTANT: Your response MUST include a valid action number from the list above</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a><span class="s2">4. Stop thinking and make a choice after a few seconds.</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a><span class="s2">5. If there is only one action, choose it without thinking.</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="s2">6. Action number should be a number from 0 to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">legal_actions</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a><span class="s2">6. Format your response as:</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="s2">    Reasoning: [brief explanation]</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a><span class="s2">    Choice: [action number]</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a><span class="s2">Make your choice now:</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a><span class="s2">        &quot;&quot;&quot;</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>        <span class="k">return</span> <span class="n">prompt</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_action</span><span class="p">(</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">game_state</span><span class="p">:</span> <span class="n">GameState</span><span class="p">,</span> <span class="n">legal_actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">]</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Action</span><span class="p">:</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the AI&#39;s chosen action based on the current game state.</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a><span class="sd">        This method:</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a><span class="sd">        1. Validates that legal actions are available</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a><span class="sd">        2. Formats the game state into a prompt</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a><span class="sd">        3. Sends the prompt to the LLM</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">        4. Extracts and validates the chosen action</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a><span class="sd">        5. Retries on failure up to max_retries times</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">        Args:</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a><span class="sd">            game_state (GameState): The current state of the game.</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a><span class="sd">            legal_actions (List[Action]): List of legal actions available.</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">        Returns:</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="sd">            Action: The chosen action to perform.</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="sd">        Raises:</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a><span class="sd">            ValueError: If no legal actions are available.</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">        Note:</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a><span class="sd">            If all retries fail, returns the first legal action as a fallback.</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">legal_actions</span><span class="p">:</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No legal actions available&quot;</span><span class="p">)</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>        <span class="c1"># Format the game state and actions into a prompt using the moved method</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_game_state</span><span class="p">(</span><span class="n">game_state</span><span class="p">,</span> <span class="n">legal_actions</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>        <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>        <span class="n">last_error</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>        <span class="k">while</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">:</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>                <span class="c1"># Get response from Ollama with system context</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">ollama</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>                    <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">GAME_CONTEXT</span><span class="p">},</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>                    <span class="p">],</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>                <span class="p">)</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>                <span class="c1"># Extract the action number from the response</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>                <span class="n">response_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># Default to empty string</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>                    <span class="c1"># Handle real response (dictionary)</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>                    <span class="k">if</span> <span class="s1">&#39;message&#39;</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="s1">&#39;content&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]:</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>                        <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">][</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">):</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>                    <span class="c1"># Handle MagicMock response (attribute access)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>                    <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Unexpected response structure: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>                    <span class="c1"># Fallback or raise error if needed, for now rely on parsing logic below to handle empty/bad string</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>                <span class="c1"># log_print(f&quot;AI Response Content: {response_text}&quot;) # Use standard print for debugging</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI Response Content: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>                <span class="c1"># Look for &quot;Choice: [number]&quot; pattern first</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>                <span class="k">if</span> <span class="n">response_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>                    <span class="n">choice_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Choice:\s*(\d+)&quot;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">)</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>                    <span class="k">if</span> <span class="n">choice_match</span><span class="p">:</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>                        <span class="n">action_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">choice_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">action_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">legal_actions</span><span class="p">):</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>                            <span class="k">return</span> <span class="n">legal_actions</span><span class="p">[</span><span class="n">action_index</span><span class="p">]</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>                    <span class="c1"># Fallback: Find any number in the response</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>                    <span class="n">all_numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">)</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>                    <span class="k">if</span> <span class="n">all_numbers</span><span class="p">:</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>                        <span class="n">action_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">all_numbers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Assume last number is choice</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">action_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">legal_actions</span><span class="p">):</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>                            <span class="k">return</span> <span class="n">legal_actions</span><span class="p">[</span><span class="n">action_index</span><span class="p">]</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>                <span class="c1"># If extraction fails, log error and increment retries</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>                <span class="n">log_print</span><span class="p">(</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>                    <span class="sa">f</span><span class="s2">&quot;Error: Could not extract action number from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>                <span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to extract action number from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>                <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span><span class="p">)</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>                <span class="n">log_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during AI action selection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># Store the error message</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>                <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span><span class="p">)</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI failed to choose an action after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> retries. Error: </span><span class="si">{</span><span class="n">last_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>        <span class="k">return</span> <span class="n">legal_actions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the language model used by the AI player.&quot;&quot;&quot;</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">choose_card_from_discard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discard_pile</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Card</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Card</span><span class="p">:</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Choose a card from the discard pile when playing a Three.&quot;&quot;&quot;</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="c1"># Format the prompt for the LLM</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a><span class="s2">        You need to choose a card from the discard pile. Here are the available cards:</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="s2">        </span><span class="si">{</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">card</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">discard_pile</span><span class="p">]</span><span class="si">}</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a><span class="s2">        Consider these factors when choosing:</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a><span class="s2">        1. High point cards (7-10) are valuable for scoring</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a><span class="s2">        2. Face cards (Kings, Queens, Jacks) provide powerful effects</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a><span class="s2">        3. Twos are valuable for countering one-offs</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a><span class="s2">        4. One-off cards (Aces, Threes, Fives, Sixes) can be useful for special effects</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a><span class="s2">        Instructions:</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="s2">        1. Analyze the available cards</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a><span class="s2">        2. Choose the most valuable card based on the game rules and strategies</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a><span class="s2">        3. IMPORTANT: Your response MUST be a number from 0 to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">discard_pile</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a><span class="s2">        4. Format your response as:</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a><span class="s2">           Reasoning: [brief explanation]</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a><span class="s2">           Choice: [index number]</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="s2">        Make your choice now:</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a><span class="s2">        &quot;&quot;&quot;</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>        <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>        <span class="n">last_error</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>        <span class="k">while</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">:</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>                <span class="c1"># Get response from Ollama with system context</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">ollama</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>                    <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">GAME_CONTEXT</span><span class="p">},</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>                    <span class="p">],</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>                <span class="p">)</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                <span class="c1"># Extract the chosen card index from the response</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                <span class="n">log_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI Response (Choose Card): </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>                <span class="k">if</span> <span class="n">response_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>                    <span class="n">choice_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Choice:\s*(\d+)&quot;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">)</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>                    <span class="k">if</span> <span class="n">choice_match</span><span class="p">:</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>                        <span class="n">card_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">choice_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">card_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">discard_pile</span><span class="p">):</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>                            <span class="k">return</span> <span class="n">discard_pile</span><span class="p">[</span><span class="n">card_index</span><span class="p">]</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>                    <span class="c1"># Fallback: Find any number in the response</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>                    <span class="n">all_numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>                    <span class="k">if</span> <span class="n">all_numbers</span><span class="p">:</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>                        <span class="n">card_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">all_numbers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">card_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">discard_pile</span><span class="p">):</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>                            <span class="k">return</span> <span class="n">discard_pile</span><span class="p">[</span><span class="n">card_index</span><span class="p">]</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>                <span class="n">log_print</span><span class="p">(</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>                    <span class="sa">f</span><span class="s2">&quot;Error: Could not extract card choice from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>                <span class="p">)</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to extract card choice from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>                <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span><span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>                <span class="n">log_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during AI card choice (discard): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>                <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span><span class="p">)</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>        <span class="n">log_print</span><span class="p">(</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>            <span class="sa">f</span><span class="s2">&quot;All retries failed. Using first card from discard pile. Last error: </span><span class="si">{</span><span class="n">last_error</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>        <span class="p">)</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>        <span class="k">return</span> <span class="n">discard_pile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">choose_two_cards_from_hand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hand</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Card</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Card</span><span class="p">]:</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Choose up to two cards to discard from hand when affected by a Four one-off effect.&quot;&quot;&quot;</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>        <span class="c1"># Format the prompt for the LLM</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a><span class="s2">        You need to choose up to two cards to discard from your hand. Here are the available cards:</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a><span class="s2">        </span><span class="si">{</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">card</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">hand</span><span class="p">]</span><span class="si">}</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a><span class="s2">        Consider these factors when choosing:</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a><span class="s2">        1. Prioritize discarding low-value point cards (1-6)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a><span class="s2">        2. Avoid discarding valuable cards like:</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a><span class="s2">           - High point cards (7-10)</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a><span class="s2">           - Face cards (Kings, Queens, Jacks)</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a><span class="s2">           - Twos (valuable for countering one-offs)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a><span class="s2">           - One-off cards (Aces, Threes, Fives, Sixes)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a><span class="s2">        3. If you have multiple low-value cards, choose the ones with the lowest point values</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a><span class="s2">        Instructions:</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a><span class="s2">        1. Analyze the available cards</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a><span class="s2">        2. Choose up to two cards to discard based on the game rules and strategies</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a><span class="s2">        3. IMPORTANT: Your response MUST be a comma-separated list of numbers from 0 to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">hand</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a><span class="s2">        4. Format your response as:</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a><span class="s2">           Reasoning: [brief explanation]</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="s2">           Choice: [index1, index2]</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a><span class="s2">        Make your choice now:</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a><span class="s2">        &quot;&quot;&quot;</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>        <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>        <span class="n">last_error</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>        <span class="k">while</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">:</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>                <span class="c1"># Get response from Ollama with system context</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">ollama</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                    <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">GAME_CONTEXT</span><span class="p">},</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>                    <span class="p">],</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>                <span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>                <span class="c1"># Extract the card indices from the response</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>                <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>                <span class="n">log_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI Response (Choose Two Cards): </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>                <span class="k">if</span> <span class="n">response_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>                    <span class="n">choice_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>                        <span class="sa">r</span><span class="s2">&quot;Choice:\s*(\d+),\s*(\d+)&quot;</span><span class="p">,</span> <span class="n">response_text</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>                    <span class="p">)</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>                    <span class="k">if</span> <span class="n">choice_match</span><span class="p">:</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>                        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">choice_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">choice_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))]</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>                        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hand</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>                            <span class="k">return</span> <span class="p">[</span><span class="n">hand</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>                    <span class="c1"># Fallback: Find all numbers and take the last two distinct ones</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>                    <span class="n">all_numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">)</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>                    <span class="n">valid_indices</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">all_numbers</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hand</span><span class="p">)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>                    <span class="p">]</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>                    <span class="c1"># Get unique indices while preserving order (last occurrence)</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>                    <span class="n">unique_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_indices</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>                        <span class="n">chosen_indices</span> <span class="o">=</span> <span class="n">unique_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>                        <span class="k">return</span> <span class="p">[</span><span class="n">hand</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chosen_indices</span><span class="p">]</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>                <span class="n">log_print</span><span class="p">(</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>                    <span class="sa">f</span><span class="s2">&quot;Error: Could not extract two card choices from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>                <span class="p">)</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to extract two card choices from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>                <span class="n">log_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during AI card choice (hand): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>                <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span><span class="p">)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>        <span class="n">log_print</span><span class="p">(</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>            <span class="sa">f</span><span class="s2">&quot;All retries failed. Using first two cards from hand. Last error: </span><span class="si">{</span><span class="n">last_error</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>        <span class="p">)</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>        <span class="c1"># Return up to 2 cards from the hand</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>        <span class="k">return</span> <span class="n">hand</span><span class="p">[:</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hand</span><span class="p">))]</span>
</span></pre></div>


            </section>
                <section id="AIPlayer">
                            <input id="AIPlayer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">AIPlayer</span>:

                <label class="view-source-button" for="AIPlayer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AIPlayer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AIPlayer-23"><a href="#AIPlayer-23"><span class="linenos"> 23</span></a><span class="k">class</span><span class="w"> </span><span class="nc">AIPlayer</span><span class="p">:</span>
</span><span id="AIPlayer-24"><a href="#AIPlayer-24"><span class="linenos"> 24</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;AI player that uses Ollama LLM to make decisions in the game.</span>
</span><span id="AIPlayer-25"><a href="#AIPlayer-25"><span class="linenos"> 25</span></a>
</span><span id="AIPlayer-26"><a href="#AIPlayer-26"><span class="linenos"> 26</span></a><span class="sd">    This class implements an AI player that uses a large language model (LLM)</span>
</span><span id="AIPlayer-27"><a href="#AIPlayer-27"><span class="linenos"> 27</span></a><span class="sd">    to analyze game states and make strategic decisions. It understands game rules,</span>
</span><span id="AIPlayer-28"><a href="#AIPlayer-28"><span class="linenos"> 28</span></a><span class="sd">    implements various strategies, and tries to avoid common mistakes.</span>
</span><span id="AIPlayer-29"><a href="#AIPlayer-29"><span class="linenos"> 29</span></a>
</span><span id="AIPlayer-30"><a href="#AIPlayer-30"><span class="linenos"> 30</span></a><span class="sd">    The AI player can:</span>
</span><span id="AIPlayer-31"><a href="#AIPlayer-31"><span class="linenos"> 31</span></a><span class="sd">    - Analyze the current game state</span>
</span><span id="AIPlayer-32"><a href="#AIPlayer-32"><span class="linenos"> 32</span></a><span class="sd">    - Choose optimal actions from available legal moves</span>
</span><span id="AIPlayer-33"><a href="#AIPlayer-33"><span class="linenos"> 33</span></a><span class="sd">    - Make strategic decisions about card usage</span>
</span><span id="AIPlayer-34"><a href="#AIPlayer-34"><span class="linenos"> 34</span></a><span class="sd">    - Handle special card effects and combinations</span>
</span><span id="AIPlayer-35"><a href="#AIPlayer-35"><span class="linenos"> 35</span></a>
</span><span id="AIPlayer-36"><a href="#AIPlayer-36"><span class="linenos"> 36</span></a><span class="sd">    Attributes:</span>
</span><span id="AIPlayer-37"><a href="#AIPlayer-37"><span class="linenos"> 37</span></a><span class="sd">        model (str): The Ollama model to use for decision making.</span>
</span><span id="AIPlayer-38"><a href="#AIPlayer-38"><span class="linenos"> 38</span></a><span class="sd">        max_retries (int): Maximum number of retries for failed LLM calls.</span>
</span><span id="AIPlayer-39"><a href="#AIPlayer-39"><span class="linenos"> 39</span></a><span class="sd">        retry_delay (int): Delay in seconds between retries.</span>
</span><span id="AIPlayer-40"><a href="#AIPlayer-40"><span class="linenos"> 40</span></a><span class="sd">        GAME_CONTEXT (str): Detailed game rules and strategy guide for the LLM.</span>
</span><span id="AIPlayer-41"><a href="#AIPlayer-41"><span class="linenos"> 41</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="AIPlayer-42"><a href="#AIPlayer-42"><span class="linenos"> 42</span></a>
</span><span id="AIPlayer-43"><a href="#AIPlayer-43"><span class="linenos"> 43</span></a>    <span class="c1"># Game rules and strategy context for the LLM</span>
</span><span id="AIPlayer-44"><a href="#AIPlayer-44"><span class="linenos"> 44</span></a>    <span class="n">GAME_CONTEXT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
</span><span id="AIPlayer-45"><a href="#AIPlayer-45"><span class="linenos"> 45</span></a><span class="s2">You are an expert of playing competitive card games. You excel at reasoning through the rules of the card game and making optimal decisions. You are great at identifying patterns and making strategic moves. You are playing a card game called Cuttle. Here are the key rules and strategies:</span>
</span><span id="AIPlayer-46"><a href="#AIPlayer-46"><span class="linenos"> 46</span></a>
</span><span id="AIPlayer-47"><a href="#AIPlayer-47"><span class="linenos"> 47</span></a><span class="s2">Rules:</span>
</span><span id="AIPlayer-48"><a href="#AIPlayer-48"><span class="linenos"> 48</span></a><span class="s2">1. Win condition: Reach your point target (initial target is 21 points)</span>
</span><span id="AIPlayer-49"><a href="#AIPlayer-49"><span class="linenos"> 49</span></a><span class="s2">2. Card Actions:</span>
</span><span id="AIPlayer-50"><a href="#AIPlayer-50"><span class="linenos"> 50</span></a><span class="s2">    - Play as points (number cards 1-10), only Ace through Ten are counted as points. Eight played as face card is not counted as points.</span>
</span><span id="AIPlayer-51"><a href="#AIPlayer-51"><span class="linenos"> 51</span></a><span class="s2">    - Play as face cards (Kings, Queens, Jacks, Eights)</span>
</span><span id="AIPlayer-52"><a href="#AIPlayer-52"><span class="linenos"> 52</span></a><span class="s2">    - Play as one-off effects (Aces, Threes, Fours, Fives, Sixes)</span>
</span><span id="AIPlayer-53"><a href="#AIPlayer-53"><span class="linenos"> 53</span></a><span class="s2">        - Aces clears all point cards for both players</span>
</span><span id="AIPlayer-54"><a href="#AIPlayer-54"><span class="linenos"> 54</span></a><span class="s2">        - Threes let&#39;s you choose a card from the scrap pile. Avoid playing Threes as one-off when the scrap pile is empty or does not have any cards you want.</span>
</span><span id="AIPlayer-55"><a href="#AIPlayer-55"><span class="linenos"> 55</span></a><span class="s2">        - Fives will let you draw the top two cards from the deck.</span>
</span><span id="AIPlayer-56"><a href="#AIPlayer-56"><span class="linenos"> 56</span></a><span class="s2">        - Sixes clears all face cards for both players</span>
</span><span id="AIPlayer-57"><a href="#AIPlayer-57"><span class="linenos"> 57</span></a><span class="s2">    - Scuttle: Play a higher point card to destroy opponent&#39;s point card</span>
</span><span id="AIPlayer-58"><a href="#AIPlayer-58"><span class="linenos"> 58</span></a><span class="s2">    - Counter: Use a Two to counter any one-off effect</span>
</span><span id="AIPlayer-59"><a href="#AIPlayer-59"><span class="linenos"> 59</span></a><span class="s2">3. Kings reduce your target score (1 King: 14, 2 Kings: 10, 3 Kings: 5, 4 Kings: 0)</span>
</span><span id="AIPlayer-60"><a href="#AIPlayer-60"><span class="linenos"> 60</span></a><span class="s2">4. Face cards provide special abilities. Face cards are not counted as points.</span>
</span><span id="AIPlayer-61"><a href="#AIPlayer-61"><span class="linenos"> 61</span></a><span class="s2">    - King: Reduces target score</span>
</span><span id="AIPlayer-62"><a href="#AIPlayer-62"><span class="linenos"> 62</span></a><span class="s2">    - Queen: Protects your points from face cards, certain targeted one-offs, and counters. Does not protect against Ace One-offs or Six One-offs.</span>
</span><span id="AIPlayer-63"><a href="#AIPlayer-63"><span class="linenos"> 63</span></a><span class="s2">    - Jack: Steals opponent&#39;s points</span>
</span><span id="AIPlayer-64"><a href="#AIPlayer-64"><span class="linenos"> 64</span></a><span class="s2">    - Eight: Glasses (opponent plays with revealed hand)</span>
</span><span id="AIPlayer-65"><a href="#AIPlayer-65"><span class="linenos"> 65</span></a>
</span><span id="AIPlayer-66"><a href="#AIPlayer-66"><span class="linenos"> 66</span></a>
</span><span id="AIPlayer-67"><a href="#AIPlayer-67"><span class="linenos"> 67</span></a><span class="s2">Strategies:</span>
</span><span id="AIPlayer-68"><a href="#AIPlayer-68"><span class="linenos"> 68</span></a><span class="s2">1. Optimize to increase your score and decrease your target score. If you have a high value point card, try to play it as points. If a move increases your score to meet or exceed your target score, do it straight away.</span>
</span><span id="AIPlayer-69"><a href="#AIPlayer-69"><span class="linenos"> 69</span></a><span class="s2">2. Prioritize playing Kings early to reduce your target score</span>
</span><span id="AIPlayer-70"><a href="#AIPlayer-70"><span class="linenos"> 70</span></a><span class="s2">3. Save Twos for countering important one-off effects. Favor drawing a card over playing a two as points.</span>
</span><span id="AIPlayer-71"><a href="#AIPlayer-71"><span class="linenos"> 71</span></a><span class="s2">4. Use Jacks to steal high-value point cards</span>
</span><span id="AIPlayer-72"><a href="#AIPlayer-72"><span class="linenos"> 72</span></a><span class="s2">5. Protect high-value points with Queens</span>
</span><span id="AIPlayer-73"><a href="#AIPlayer-73"><span class="linenos"> 73</span></a><span class="s2">6. Use Aces to clear opponent&#39;s strong point cards. Avoid playing Aces as one-off when opponent doesn&#39;t have any point cards on field. Avoid playing Aces as points when possible since the reward is low.</span>
</span><span id="AIPlayer-74"><a href="#AIPlayer-74"><span class="linenos"> 74</span></a><span class="s2">7. Keep track of used Twos to know when one-offs are safe</span>
</span><span id="AIPlayer-75"><a href="#AIPlayer-75"><span class="linenos"> 75</span></a><span class="s2">8. Scuttle opponent&#39;s high-value points when possible</span>
</span><span id="AIPlayer-76"><a href="#AIPlayer-76"><span class="linenos"> 76</span></a><span class="s2">9. Avoid playing Six as one-off when opponent doesn&#39;t have any face cards on field.</span>
</span><span id="AIPlayer-77"><a href="#AIPlayer-77"><span class="linenos"> 77</span></a><span class="s2">10. If opponent score is close to opponent&#39;s target, try to play Aces as one-off to clear their points, or play Sixes as one-off to clear their Kings if any are on field.</span>
</span><span id="AIPlayer-78"><a href="#AIPlayer-78"><span class="linenos"> 78</span></a>
</span><span id="AIPlayer-79"><a href="#AIPlayer-79"><span class="linenos"> 79</span></a><span class="s2">Mistakes to avoid:</span>
</span><span id="AIPlayer-80"><a href="#AIPlayer-80"><span class="linenos"> 80</span></a><span class="s2">1. Playing Aces as one-off when opponent doesn&#39;t have any point cards on field.</span>
</span><span id="AIPlayer-81"><a href="#AIPlayer-81"><span class="linenos"> 81</span></a><span class="s2">2. Playing Aces as points since the reward is low.</span>
</span><span id="AIPlayer-82"><a href="#AIPlayer-82"><span class="linenos"> 82</span></a><span class="s2">3. Playing Threes as one-off when the scrap pile is empty or does not have any cards you want.</span>
</span><span id="AIPlayer-83"><a href="#AIPlayer-83"><span class="linenos"> 83</span></a><span class="s2">4. Playing Sixes as one-off when opponent doesn&#39;t have any face cards on field.</span>
</span><span id="AIPlayer-84"><a href="#AIPlayer-84"><span class="linenos"> 84</span></a>
</span><span id="AIPlayer-85"><a href="#AIPlayer-85"><span class="linenos"> 85</span></a><span class="s2">The Strategy is key to winning the game.</span>
</span><span id="AIPlayer-86"><a href="#AIPlayer-86"><span class="linenos"> 86</span></a><span class="s2">    &quot;&quot;&quot;</span>
</span><span id="AIPlayer-87"><a href="#AIPlayer-87"><span class="linenos"> 87</span></a>
</span><span id="AIPlayer-88"><a href="#AIPlayer-88"><span class="linenos"> 88</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retry_delay</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AIPlayer-89"><a href="#AIPlayer-89"><span class="linenos"> 89</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the AI player.</span>
</span><span id="AIPlayer-90"><a href="#AIPlayer-90"><span class="linenos"> 90</span></a>
</span><span id="AIPlayer-91"><a href="#AIPlayer-91"><span class="linenos"> 91</span></a><span class="sd">        Sets up:</span>
</span><span id="AIPlayer-92"><a href="#AIPlayer-92"><span class="linenos"> 92</span></a><span class="sd">        - The default language model (gemma3:4b)</span>
</span><span id="AIPlayer-93"><a href="#AIPlayer-93"><span class="linenos"> 93</span></a><span class="sd">        - Retry settings for LLM calls</span>
</span><span id="AIPlayer-94"><a href="#AIPlayer-94"><span class="linenos"> 94</span></a><span class="sd">        - Verifies AI&#39;s understanding of game rules</span>
</span><span id="AIPlayer-95"><a href="#AIPlayer-95"><span class="linenos"> 95</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AIPlayer-96"><a href="#AIPlayer-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;gemma3:4b&quot;</span>  <span class="c1"># Default to mistral model</span>
</span><span id="AIPlayer-97"><a href="#AIPlayer-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>
</span><span id="AIPlayer-98"><a href="#AIPlayer-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span> <span class="o">=</span> <span class="n">retry_delay</span>  <span class="c1"># seconds</span>
</span><span id="AIPlayer-99"><a href="#AIPlayer-99"><span class="linenos"> 99</span></a>
</span><span id="AIPlayer-100"><a href="#AIPlayer-100"><span class="linenos">100</span></a>        <span class="c1"># Initialize system context and verify AI understanding</span>
</span><span id="AIPlayer-101"><a href="#AIPlayer-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_ai_understanding</span><span class="p">()</span>
</span><span id="AIPlayer-102"><a href="#AIPlayer-102"><span class="linenos">102</span></a>
</span><span id="AIPlayer-103"><a href="#AIPlayer-103"><span class="linenos">103</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_verify_ai_understanding</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AIPlayer-104"><a href="#AIPlayer-104"><span class="linenos">104</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify that the AI understands the game rules and strategies.</span>
</span><span id="AIPlayer-105"><a href="#AIPlayer-105"><span class="linenos">105</span></a>
</span><span id="AIPlayer-106"><a href="#AIPlayer-106"><span class="linenos">106</span></a><span class="sd">        This method sends a test prompt to the LLM to confirm it understands</span>
</span><span id="AIPlayer-107"><a href="#AIPlayer-107"><span class="linenos">107</span></a><span class="sd">        the game rules and strategies. The response is logged for debugging.</span>
</span><span id="AIPlayer-108"><a href="#AIPlayer-108"><span class="linenos">108</span></a>
</span><span id="AIPlayer-109"><a href="#AIPlayer-109"><span class="linenos">109</span></a><span class="sd">        Note:</span>
</span><span id="AIPlayer-110"><a href="#AIPlayer-110"><span class="linenos">110</span></a><span class="sd">            If verification fails, a warning is logged but the AI can still function.</span>
</span><span id="AIPlayer-111"><a href="#AIPlayer-111"><span class="linenos">111</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AIPlayer-112"><a href="#AIPlayer-112"><span class="linenos">112</span></a>        <span class="n">verification_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Please confirm that you understand the game rules and strategies for Cuttle.</span>
</span><span id="AIPlayer-113"><a href="#AIPlayer-113"><span class="linenos">113</span></a><span class="s2">Respond with a brief summary of your understanding and confirm that you will avoid the common mistakes listed.</span>
</span><span id="AIPlayer-114"><a href="#AIPlayer-114"><span class="linenos">114</span></a><span class="s2">Keep your response concise.&quot;&quot;&quot;</span>
</span><span id="AIPlayer-115"><a href="#AIPlayer-115"><span class="linenos">115</span></a>
</span><span id="AIPlayer-116"><a href="#AIPlayer-116"><span class="linenos">116</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AIPlayer-117"><a href="#AIPlayer-117"><span class="linenos">117</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">ollama</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
</span><span id="AIPlayer-118"><a href="#AIPlayer-118"><span class="linenos">118</span></a>                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="AIPlayer-119"><a href="#AIPlayer-119"><span class="linenos">119</span></a>                <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span><span id="AIPlayer-120"><a href="#AIPlayer-120"><span class="linenos">120</span></a>                    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">GAME_CONTEXT</span><span class="p">},</span>
</span><span id="AIPlayer-121"><a href="#AIPlayer-121"><span class="linenos">121</span></a>                    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">verification_prompt</span><span class="p">},</span>
</span><span id="AIPlayer-122"><a href="#AIPlayer-122"><span class="linenos">122</span></a>                <span class="p">],</span>
</span><span id="AIPlayer-123"><a href="#AIPlayer-123"><span class="linenos">123</span></a>            <span class="p">)</span>
</span><span id="AIPlayer-124"><a href="#AIPlayer-124"><span class="linenos">124</span></a>            <span class="n">log_print</span><span class="p">(</span><span class="s2">&quot;AI Understanding Verification:&quot;</span><span class="p">)</span>
</span><span id="AIPlayer-125"><a href="#AIPlayer-125"><span class="linenos">125</span></a>            <span class="n">log_print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span><span id="AIPlayer-126"><a href="#AIPlayer-126"><span class="linenos">126</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AIPlayer-127"><a href="#AIPlayer-127"><span class="linenos">127</span></a>            <span class="n">log_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not verify AI understanding: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AIPlayer-128"><a href="#AIPlayer-128"><span class="linenos">128</span></a>
</span><span id="AIPlayer-129"><a href="#AIPlayer-129"><span class="linenos">129</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_format_game_state</span><span class="p">(</span>
</span><span id="AIPlayer-130"><a href="#AIPlayer-130"><span class="linenos">130</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AIPlayer-131"><a href="#AIPlayer-131"><span class="linenos">131</span></a>        <span class="n">game_state</span><span class="p">:</span> <span class="n">GameState</span><span class="p">,</span>
</span><span id="AIPlayer-132"><a href="#AIPlayer-132"><span class="linenos">132</span></a>        <span class="n">legal_actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">],</span>
</span><span id="AIPlayer-133"><a href="#AIPlayer-133"><span class="linenos">133</span></a>        <span class="n">is_human_view</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="AIPlayer-134"><a href="#AIPlayer-134"><span class="linenos">134</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="AIPlayer-135"><a href="#AIPlayer-135"><span class="linenos">135</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format the current game state and legal actions into a prompt for the LLM.</span>
</span><span id="AIPlayer-136"><a href="#AIPlayer-136"><span class="linenos">136</span></a>
</span><span id="AIPlayer-137"><a href="#AIPlayer-137"><span class="linenos">137</span></a><span class="sd">        This method creates a detailed prompt that includes:</span>
</span><span id="AIPlayer-138"><a href="#AIPlayer-138"><span class="linenos">138</span></a><span class="sd">        - Current state of both players (hand, field, score, target)</span>
</span><span id="AIPlayer-139"><a href="#AIPlayer-139"><span class="linenos">139</span></a><span class="sd">        - Deck and discard pile information</span>
</span><span id="AIPlayer-140"><a href="#AIPlayer-140"><span class="linenos">140</span></a><span class="sd">        - List of legal actions</span>
</span><span id="AIPlayer-141"><a href="#AIPlayer-141"><span class="linenos">141</span></a><span class="sd">        - Instructions for the LLM</span>
</span><span id="AIPlayer-142"><a href="#AIPlayer-142"><span class="linenos">142</span></a>
</span><span id="AIPlayer-143"><a href="#AIPlayer-143"><span class="linenos">143</span></a><span class="sd">        Args:</span>
</span><span id="AIPlayer-144"><a href="#AIPlayer-144"><span class="linenos">144</span></a><span class="sd">            game_state (GameState): The current state of the game.</span>
</span><span id="AIPlayer-145"><a href="#AIPlayer-145"><span class="linenos">145</span></a><span class="sd">            legal_actions (List[Action]): List of legal actions available.</span>
</span><span id="AIPlayer-146"><a href="#AIPlayer-146"><span class="linenos">146</span></a><span class="sd">            is_human_view (bool, optional): Whether to hide AI&#39;s hand. Defaults to False.</span>
</span><span id="AIPlayer-147"><a href="#AIPlayer-147"><span class="linenos">147</span></a>
</span><span id="AIPlayer-148"><a href="#AIPlayer-148"><span class="linenos">148</span></a><span class="sd">        Returns:</span>
</span><span id="AIPlayer-149"><a href="#AIPlayer-149"><span class="linenos">149</span></a><span class="sd">            str: Formatted prompt string for the LLM.</span>
</span><span id="AIPlayer-150"><a href="#AIPlayer-150"><span class="linenos">150</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AIPlayer-151"><a href="#AIPlayer-151"><span class="linenos">151</span></a>        <span class="n">opponent</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AIPlayer-152"><a href="#AIPlayer-152"><span class="linenos">152</span></a>        <span class="n">opponent_point_cards</span> <span class="o">=</span> <span class="n">game_state</span><span class="o">.</span><span class="n">player_point_cards</span><span class="p">(</span><span class="n">opponent</span><span class="p">)</span>
</span><span id="AIPlayer-153"><a href="#AIPlayer-153"><span class="linenos">153</span></a>        <span class="n">opponent_face_cards</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AIPlayer-154"><a href="#AIPlayer-154"><span class="linenos">154</span></a>            <span class="n">card</span>
</span><span id="AIPlayer-155"><a href="#AIPlayer-155"><span class="linenos">155</span></a>            <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">game_state</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="AIPlayer-156"><a href="#AIPlayer-156"><span class="linenos">156</span></a>            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">purpose</span> <span class="o">==</span> <span class="n">Purpose</span><span class="o">.</span><span class="n">FACE_CARD</span>
</span><span id="AIPlayer-157"><a href="#AIPlayer-157"><span class="linenos">157</span></a>        <span class="p">]</span>
</span><span id="AIPlayer-158"><a href="#AIPlayer-158"><span class="linenos">158</span></a>
</span><span id="AIPlayer-159"><a href="#AIPlayer-159"><span class="linenos">159</span></a>        <span class="n">legal_actions_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="AIPlayer-160"><a href="#AIPlayer-160"><span class="linenos">160</span></a>            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;- action </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">legal_actions</span><span class="p">)]</span>
</span><span id="AIPlayer-161"><a href="#AIPlayer-161"><span class="linenos">161</span></a>        <span class="p">)</span>
</span><span id="AIPlayer-162"><a href="#AIPlayer-162"><span class="linenos">162</span></a>
</span><span id="AIPlayer-163"><a href="#AIPlayer-163"><span class="linenos">163</span></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="AIPlayer-164"><a href="#AIPlayer-164"><span class="linenos">164</span></a><span class="s2">Current Game State:</span>
</span><span id="AIPlayer-165"><a href="#AIPlayer-165"><span class="linenos">165</span></a><span class="s2">AI</span>
</span><span id="AIPlayer-166"><a href="#AIPlayer-166"><span class="linenos">166</span></a><span class="si">{</span><span class="s2">&quot;AI Hand: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">game_state</span><span class="o">.</span><span class="n">hands</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">is_human_view</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;AI Hand: [Hidden]&quot;</span><span class="si">}</span>
</span><span id="AIPlayer-167"><a href="#AIPlayer-167"><span class="linenos">167</span></a><span class="s2">AI Field: </span><span class="si">{</span><span class="n">game_state</span><span class="o">.</span><span class="n">get_player_field</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span>
</span><span id="AIPlayer-168"><a href="#AIPlayer-168"><span class="linenos">168</span></a><span class="s2">AI Score: </span><span class="si">{</span><span class="n">game_state</span><span class="o">.</span><span class="n">get_player_score</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span>
</span><span id="AIPlayer-169"><a href="#AIPlayer-169"><span class="linenos">169</span></a><span class="s2">AI Target: </span><span class="si">{</span><span class="n">game_state</span><span class="o">.</span><span class="n">get_player_target</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span>
</span><span id="AIPlayer-170"><a href="#AIPlayer-170"><span class="linenos">170</span></a>
</span><span id="AIPlayer-171"><a href="#AIPlayer-171"><span class="linenos">171</span></a><span class="s2">Opponent</span>
</span><span id="AIPlayer-172"><a href="#AIPlayer-172"><span class="linenos">172</span></a><span class="s2">Opponent&#39;s Hand Size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">game_state</span><span class="o">.</span><span class="n">hands</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span>
</span><span id="AIPlayer-173"><a href="#AIPlayer-173"><span class="linenos">173</span></a><span class="s2">Opponent&#39;s Field: </span><span class="si">{</span><span class="n">game_state</span><span class="o">.</span><span class="n">get_player_field</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span>
</span><span id="AIPlayer-174"><a href="#AIPlayer-174"><span class="linenos">174</span></a><span class="s2">Opponent&#39;s Point Cards: </span><span class="si">{</span><span class="n">opponent_point_cards</span><span class="si">}</span>
</span><span id="AIPlayer-175"><a href="#AIPlayer-175"><span class="linenos">175</span></a><span class="s2">Opponent&#39;s Face Cards: </span><span class="si">{</span><span class="n">opponent_face_cards</span><span class="si">}</span>
</span><span id="AIPlayer-176"><a href="#AIPlayer-176"><span class="linenos">176</span></a><span class="s2">Opponent&#39;s Score: </span><span class="si">{</span><span class="n">game_state</span><span class="o">.</span><span class="n">get_player_score</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span>
</span><span id="AIPlayer-177"><a href="#AIPlayer-177"><span class="linenos">177</span></a><span class="s2">Opponent&#39;s Target: </span><span class="si">{</span><span class="n">game_state</span><span class="o">.</span><span class="n">get_player_target</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span>
</span><span id="AIPlayer-178"><a href="#AIPlayer-178"><span class="linenos">178</span></a>
</span><span id="AIPlayer-179"><a href="#AIPlayer-179"><span class="linenos">179</span></a><span class="s2">Deck Size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">game_state</span><span class="o">.</span><span class="n">deck</span><span class="p">)</span><span class="si">}</span>
</span><span id="AIPlayer-180"><a href="#AIPlayer-180"><span class="linenos">180</span></a><span class="s2">Discard Pile Size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">game_state</span><span class="o">.</span><span class="n">discard_pile</span><span class="p">)</span><span class="si">}</span>
</span><span id="AIPlayer-181"><a href="#AIPlayer-181"><span class="linenos">181</span></a>
</span><span id="AIPlayer-182"><a href="#AIPlayer-182"><span class="linenos">182</span></a><span class="s2">Legal Actions:</span>
</span><span id="AIPlayer-183"><a href="#AIPlayer-183"><span class="linenos">183</span></a><span class="si">{</span><span class="n">legal_actions_str</span><span class="si">}</span>
</span><span id="AIPlayer-184"><a href="#AIPlayer-184"><span class="linenos">184</span></a>
</span><span id="AIPlayer-185"><a href="#AIPlayer-185"><span class="linenos">185</span></a><span class="s2">Instructions:</span>
</span><span id="AIPlayer-186"><a href="#AIPlayer-186"><span class="linenos">186</span></a><span class="s2">1. Analyze the game state and available actions. What is opponent&#39;s score and target? What is your score and target?</span>
</span><span id="AIPlayer-187"><a href="#AIPlayer-187"><span class="linenos">187</span></a><span class="s2">2. Choose the best action among the legal actions based on the game rules and strategies, think through the consequences of your actions and a few turns ahead. Avoid making mistakes that will cost you the game.</span>
</span><span id="AIPlayer-188"><a href="#AIPlayer-188"><span class="linenos">188</span></a><span class="s2">3. IMPORTANT: Your response MUST include a valid action number from the list above</span>
</span><span id="AIPlayer-189"><a href="#AIPlayer-189"><span class="linenos">189</span></a><span class="s2">4. Stop thinking and make a choice after a few seconds.</span>
</span><span id="AIPlayer-190"><a href="#AIPlayer-190"><span class="linenos">190</span></a><span class="s2">5. If there is only one action, choose it without thinking.</span>
</span><span id="AIPlayer-191"><a href="#AIPlayer-191"><span class="linenos">191</span></a><span class="s2">6. Action number should be a number from 0 to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">legal_actions</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span>
</span><span id="AIPlayer-192"><a href="#AIPlayer-192"><span class="linenos">192</span></a><span class="s2">6. Format your response as:</span>
</span><span id="AIPlayer-193"><a href="#AIPlayer-193"><span class="linenos">193</span></a><span class="s2">    Reasoning: [brief explanation]</span>
</span><span id="AIPlayer-194"><a href="#AIPlayer-194"><span class="linenos">194</span></a><span class="s2">    Choice: [action number]</span>
</span><span id="AIPlayer-195"><a href="#AIPlayer-195"><span class="linenos">195</span></a>
</span><span id="AIPlayer-196"><a href="#AIPlayer-196"><span class="linenos">196</span></a><span class="s2">Make your choice now:</span>
</span><span id="AIPlayer-197"><a href="#AIPlayer-197"><span class="linenos">197</span></a><span class="s2">        &quot;&quot;&quot;</span>
</span><span id="AIPlayer-198"><a href="#AIPlayer-198"><span class="linenos">198</span></a>        <span class="k">return</span> <span class="n">prompt</span>
</span><span id="AIPlayer-199"><a href="#AIPlayer-199"><span class="linenos">199</span></a>
</span><span id="AIPlayer-200"><a href="#AIPlayer-200"><span class="linenos">200</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_action</span><span class="p">(</span>
</span><span id="AIPlayer-201"><a href="#AIPlayer-201"><span class="linenos">201</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">game_state</span><span class="p">:</span> <span class="n">GameState</span><span class="p">,</span> <span class="n">legal_actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">]</span>
</span><span id="AIPlayer-202"><a href="#AIPlayer-202"><span class="linenos">202</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Action</span><span class="p">:</span>
</span><span id="AIPlayer-203"><a href="#AIPlayer-203"><span class="linenos">203</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the AI&#39;s chosen action based on the current game state.</span>
</span><span id="AIPlayer-204"><a href="#AIPlayer-204"><span class="linenos">204</span></a>
</span><span id="AIPlayer-205"><a href="#AIPlayer-205"><span class="linenos">205</span></a><span class="sd">        This method:</span>
</span><span id="AIPlayer-206"><a href="#AIPlayer-206"><span class="linenos">206</span></a><span class="sd">        1. Validates that legal actions are available</span>
</span><span id="AIPlayer-207"><a href="#AIPlayer-207"><span class="linenos">207</span></a><span class="sd">        2. Formats the game state into a prompt</span>
</span><span id="AIPlayer-208"><a href="#AIPlayer-208"><span class="linenos">208</span></a><span class="sd">        3. Sends the prompt to the LLM</span>
</span><span id="AIPlayer-209"><a href="#AIPlayer-209"><span class="linenos">209</span></a><span class="sd">        4. Extracts and validates the chosen action</span>
</span><span id="AIPlayer-210"><a href="#AIPlayer-210"><span class="linenos">210</span></a><span class="sd">        5. Retries on failure up to max_retries times</span>
</span><span id="AIPlayer-211"><a href="#AIPlayer-211"><span class="linenos">211</span></a>
</span><span id="AIPlayer-212"><a href="#AIPlayer-212"><span class="linenos">212</span></a><span class="sd">        Args:</span>
</span><span id="AIPlayer-213"><a href="#AIPlayer-213"><span class="linenos">213</span></a><span class="sd">            game_state (GameState): The current state of the game.</span>
</span><span id="AIPlayer-214"><a href="#AIPlayer-214"><span class="linenos">214</span></a><span class="sd">            legal_actions (List[Action]): List of legal actions available.</span>
</span><span id="AIPlayer-215"><a href="#AIPlayer-215"><span class="linenos">215</span></a>
</span><span id="AIPlayer-216"><a href="#AIPlayer-216"><span class="linenos">216</span></a><span class="sd">        Returns:</span>
</span><span id="AIPlayer-217"><a href="#AIPlayer-217"><span class="linenos">217</span></a><span class="sd">            Action: The chosen action to perform.</span>
</span><span id="AIPlayer-218"><a href="#AIPlayer-218"><span class="linenos">218</span></a>
</span><span id="AIPlayer-219"><a href="#AIPlayer-219"><span class="linenos">219</span></a><span class="sd">        Raises:</span>
</span><span id="AIPlayer-220"><a href="#AIPlayer-220"><span class="linenos">220</span></a><span class="sd">            ValueError: If no legal actions are available.</span>
</span><span id="AIPlayer-221"><a href="#AIPlayer-221"><span class="linenos">221</span></a>
</span><span id="AIPlayer-222"><a href="#AIPlayer-222"><span class="linenos">222</span></a><span class="sd">        Note:</span>
</span><span id="AIPlayer-223"><a href="#AIPlayer-223"><span class="linenos">223</span></a><span class="sd">            If all retries fail, returns the first legal action as a fallback.</span>
</span><span id="AIPlayer-224"><a href="#AIPlayer-224"><span class="linenos">224</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AIPlayer-225"><a href="#AIPlayer-225"><span class="linenos">225</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">legal_actions</span><span class="p">:</span>
</span><span id="AIPlayer-226"><a href="#AIPlayer-226"><span class="linenos">226</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No legal actions available&quot;</span><span class="p">)</span>
</span><span id="AIPlayer-227"><a href="#AIPlayer-227"><span class="linenos">227</span></a>
</span><span id="AIPlayer-228"><a href="#AIPlayer-228"><span class="linenos">228</span></a>        <span class="c1"># Format the game state and actions into a prompt using the moved method</span>
</span><span id="AIPlayer-229"><a href="#AIPlayer-229"><span class="linenos">229</span></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_game_state</span><span class="p">(</span><span class="n">game_state</span><span class="p">,</span> <span class="n">legal_actions</span><span class="p">)</span>
</span><span id="AIPlayer-230"><a href="#AIPlayer-230"><span class="linenos">230</span></a>        <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AIPlayer-231"><a href="#AIPlayer-231"><span class="linenos">231</span></a>        <span class="n">last_error</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AIPlayer-232"><a href="#AIPlayer-232"><span class="linenos">232</span></a>
</span><span id="AIPlayer-233"><a href="#AIPlayer-233"><span class="linenos">233</span></a>        <span class="k">while</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">:</span>
</span><span id="AIPlayer-234"><a href="#AIPlayer-234"><span class="linenos">234</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AIPlayer-235"><a href="#AIPlayer-235"><span class="linenos">235</span></a>                <span class="c1"># Get response from Ollama with system context</span>
</span><span id="AIPlayer-236"><a href="#AIPlayer-236"><span class="linenos">236</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">ollama</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
</span><span id="AIPlayer-237"><a href="#AIPlayer-237"><span class="linenos">237</span></a>                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="AIPlayer-238"><a href="#AIPlayer-238"><span class="linenos">238</span></a>                    <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span><span id="AIPlayer-239"><a href="#AIPlayer-239"><span class="linenos">239</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">GAME_CONTEXT</span><span class="p">},</span>
</span><span id="AIPlayer-240"><a href="#AIPlayer-240"><span class="linenos">240</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
</span><span id="AIPlayer-241"><a href="#AIPlayer-241"><span class="linenos">241</span></a>                    <span class="p">],</span>
</span><span id="AIPlayer-242"><a href="#AIPlayer-242"><span class="linenos">242</span></a>                <span class="p">)</span>
</span><span id="AIPlayer-243"><a href="#AIPlayer-243"><span class="linenos">243</span></a>
</span><span id="AIPlayer-244"><a href="#AIPlayer-244"><span class="linenos">244</span></a>                <span class="c1"># Extract the action number from the response</span>
</span><span id="AIPlayer-245"><a href="#AIPlayer-245"><span class="linenos">245</span></a>                <span class="n">response_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># Default to empty string</span>
</span><span id="AIPlayer-246"><a href="#AIPlayer-246"><span class="linenos">246</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="AIPlayer-247"><a href="#AIPlayer-247"><span class="linenos">247</span></a>                    <span class="c1"># Handle real response (dictionary)</span>
</span><span id="AIPlayer-248"><a href="#AIPlayer-248"><span class="linenos">248</span></a>                    <span class="k">if</span> <span class="s1">&#39;message&#39;</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="s1">&#39;content&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]:</span>
</span><span id="AIPlayer-249"><a href="#AIPlayer-249"><span class="linenos">249</span></a>                        <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">][</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
</span><span id="AIPlayer-250"><a href="#AIPlayer-250"><span class="linenos">250</span></a>                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">):</span>
</span><span id="AIPlayer-251"><a href="#AIPlayer-251"><span class="linenos">251</span></a>                    <span class="c1"># Handle MagicMock response (attribute access)</span>
</span><span id="AIPlayer-252"><a href="#AIPlayer-252"><span class="linenos">252</span></a>                    <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span><span id="AIPlayer-253"><a href="#AIPlayer-253"><span class="linenos">253</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AIPlayer-254"><a href="#AIPlayer-254"><span class="linenos">254</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Unexpected response structure: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AIPlayer-255"><a href="#AIPlayer-255"><span class="linenos">255</span></a>                    <span class="c1"># Fallback or raise error if needed, for now rely on parsing logic below to handle empty/bad string</span>
</span><span id="AIPlayer-256"><a href="#AIPlayer-256"><span class="linenos">256</span></a>
</span><span id="AIPlayer-257"><a href="#AIPlayer-257"><span class="linenos">257</span></a>                <span class="c1"># log_print(f&quot;AI Response Content: {response_text}&quot;) # Use standard print for debugging</span>
</span><span id="AIPlayer-258"><a href="#AIPlayer-258"><span class="linenos">258</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI Response Content: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AIPlayer-259"><a href="#AIPlayer-259"><span class="linenos">259</span></a>                <span class="c1"># Look for &quot;Choice: [number]&quot; pattern first</span>
</span><span id="AIPlayer-260"><a href="#AIPlayer-260"><span class="linenos">260</span></a>                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="AIPlayer-261"><a href="#AIPlayer-261"><span class="linenos">261</span></a>
</span><span id="AIPlayer-262"><a href="#AIPlayer-262"><span class="linenos">262</span></a>                <span class="k">if</span> <span class="n">response_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AIPlayer-263"><a href="#AIPlayer-263"><span class="linenos">263</span></a>                    <span class="n">choice_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Choice:\s*(\d+)&quot;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">)</span>
</span><span id="AIPlayer-264"><a href="#AIPlayer-264"><span class="linenos">264</span></a>                    <span class="k">if</span> <span class="n">choice_match</span><span class="p">:</span>
</span><span id="AIPlayer-265"><a href="#AIPlayer-265"><span class="linenos">265</span></a>                        <span class="n">action_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">choice_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="AIPlayer-266"><a href="#AIPlayer-266"><span class="linenos">266</span></a>                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">action_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">legal_actions</span><span class="p">):</span>
</span><span id="AIPlayer-267"><a href="#AIPlayer-267"><span class="linenos">267</span></a>                            <span class="k">return</span> <span class="n">legal_actions</span><span class="p">[</span><span class="n">action_index</span><span class="p">]</span>
</span><span id="AIPlayer-268"><a href="#AIPlayer-268"><span class="linenos">268</span></a>
</span><span id="AIPlayer-269"><a href="#AIPlayer-269"><span class="linenos">269</span></a>                    <span class="c1"># Fallback: Find any number in the response</span>
</span><span id="AIPlayer-270"><a href="#AIPlayer-270"><span class="linenos">270</span></a>                    <span class="n">all_numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">)</span>
</span><span id="AIPlayer-271"><a href="#AIPlayer-271"><span class="linenos">271</span></a>                    <span class="k">if</span> <span class="n">all_numbers</span><span class="p">:</span>
</span><span id="AIPlayer-272"><a href="#AIPlayer-272"><span class="linenos">272</span></a>                        <span class="n">action_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">all_numbers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Assume last number is choice</span>
</span><span id="AIPlayer-273"><a href="#AIPlayer-273"><span class="linenos">273</span></a>                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">action_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">legal_actions</span><span class="p">):</span>
</span><span id="AIPlayer-274"><a href="#AIPlayer-274"><span class="linenos">274</span></a>                            <span class="k">return</span> <span class="n">legal_actions</span><span class="p">[</span><span class="n">action_index</span><span class="p">]</span>
</span><span id="AIPlayer-275"><a href="#AIPlayer-275"><span class="linenos">275</span></a>
</span><span id="AIPlayer-276"><a href="#AIPlayer-276"><span class="linenos">276</span></a>                <span class="c1"># If extraction fails, log error and increment retries</span>
</span><span id="AIPlayer-277"><a href="#AIPlayer-277"><span class="linenos">277</span></a>                <span class="n">log_print</span><span class="p">(</span>
</span><span id="AIPlayer-278"><a href="#AIPlayer-278"><span class="linenos">278</span></a>                    <span class="sa">f</span><span class="s2">&quot;Error: Could not extract action number from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AIPlayer-279"><a href="#AIPlayer-279"><span class="linenos">279</span></a>                <span class="p">)</span>
</span><span id="AIPlayer-280"><a href="#AIPlayer-280"><span class="linenos">280</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to extract action number from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AIPlayer-281"><a href="#AIPlayer-281"><span class="linenos">281</span></a>                <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AIPlayer-282"><a href="#AIPlayer-282"><span class="linenos">282</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span><span class="p">)</span>
</span><span id="AIPlayer-283"><a href="#AIPlayer-283"><span class="linenos">283</span></a>
</span><span id="AIPlayer-284"><a href="#AIPlayer-284"><span class="linenos">284</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AIPlayer-285"><a href="#AIPlayer-285"><span class="linenos">285</span></a>                <span class="n">log_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during AI action selection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AIPlayer-286"><a href="#AIPlayer-286"><span class="linenos">286</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># Store the error message</span>
</span><span id="AIPlayer-287"><a href="#AIPlayer-287"><span class="linenos">287</span></a>                <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AIPlayer-288"><a href="#AIPlayer-288"><span class="linenos">288</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span><span class="p">)</span>
</span><span id="AIPlayer-289"><a href="#AIPlayer-289"><span class="linenos">289</span></a>
</span><span id="AIPlayer-290"><a href="#AIPlayer-290"><span class="linenos">290</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI failed to choose an action after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> retries. Error: </span><span class="si">{</span><span class="n">last_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AIPlayer-291"><a href="#AIPlayer-291"><span class="linenos">291</span></a>        <span class="k">return</span> <span class="n">legal_actions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="AIPlayer-292"><a href="#AIPlayer-292"><span class="linenos">292</span></a>
</span><span id="AIPlayer-293"><a href="#AIPlayer-293"><span class="linenos">293</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AIPlayer-294"><a href="#AIPlayer-294"><span class="linenos">294</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the language model used by the AI player.&quot;&quot;&quot;</span>
</span><span id="AIPlayer-295"><a href="#AIPlayer-295"><span class="linenos">295</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="AIPlayer-296"><a href="#AIPlayer-296"><span class="linenos">296</span></a>
</span><span id="AIPlayer-297"><a href="#AIPlayer-297"><span class="linenos">297</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">choose_card_from_discard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discard_pile</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Card</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Card</span><span class="p">:</span>
</span><span id="AIPlayer-298"><a href="#AIPlayer-298"><span class="linenos">298</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Choose a card from the discard pile when playing a Three.&quot;&quot;&quot;</span>
</span><span id="AIPlayer-299"><a href="#AIPlayer-299"><span class="linenos">299</span></a>        <span class="c1"># Format the prompt for the LLM</span>
</span><span id="AIPlayer-300"><a href="#AIPlayer-300"><span class="linenos">300</span></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="AIPlayer-301"><a href="#AIPlayer-301"><span class="linenos">301</span></a><span class="s2">        You need to choose a card from the discard pile. Here are the available cards:</span>
</span><span id="AIPlayer-302"><a href="#AIPlayer-302"><span class="linenos">302</span></a><span class="s2">        </span><span class="si">{</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">card</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">discard_pile</span><span class="p">]</span><span class="si">}</span>
</span><span id="AIPlayer-303"><a href="#AIPlayer-303"><span class="linenos">303</span></a>
</span><span id="AIPlayer-304"><a href="#AIPlayer-304"><span class="linenos">304</span></a><span class="s2">        Consider these factors when choosing:</span>
</span><span id="AIPlayer-305"><a href="#AIPlayer-305"><span class="linenos">305</span></a><span class="s2">        1. High point cards (7-10) are valuable for scoring</span>
</span><span id="AIPlayer-306"><a href="#AIPlayer-306"><span class="linenos">306</span></a><span class="s2">        2. Face cards (Kings, Queens, Jacks) provide powerful effects</span>
</span><span id="AIPlayer-307"><a href="#AIPlayer-307"><span class="linenos">307</span></a><span class="s2">        3. Twos are valuable for countering one-offs</span>
</span><span id="AIPlayer-308"><a href="#AIPlayer-308"><span class="linenos">308</span></a><span class="s2">        4. One-off cards (Aces, Threes, Fives, Sixes) can be useful for special effects</span>
</span><span id="AIPlayer-309"><a href="#AIPlayer-309"><span class="linenos">309</span></a>
</span><span id="AIPlayer-310"><a href="#AIPlayer-310"><span class="linenos">310</span></a><span class="s2">        Instructions:</span>
</span><span id="AIPlayer-311"><a href="#AIPlayer-311"><span class="linenos">311</span></a><span class="s2">        1. Analyze the available cards</span>
</span><span id="AIPlayer-312"><a href="#AIPlayer-312"><span class="linenos">312</span></a><span class="s2">        2. Choose the most valuable card based on the game rules and strategies</span>
</span><span id="AIPlayer-313"><a href="#AIPlayer-313"><span class="linenos">313</span></a><span class="s2">        3. IMPORTANT: Your response MUST be a number from 0 to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">discard_pile</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span>
</span><span id="AIPlayer-314"><a href="#AIPlayer-314"><span class="linenos">314</span></a><span class="s2">        4. Format your response as:</span>
</span><span id="AIPlayer-315"><a href="#AIPlayer-315"><span class="linenos">315</span></a><span class="s2">           Reasoning: [brief explanation]</span>
</span><span id="AIPlayer-316"><a href="#AIPlayer-316"><span class="linenos">316</span></a><span class="s2">           Choice: [index number]</span>
</span><span id="AIPlayer-317"><a href="#AIPlayer-317"><span class="linenos">317</span></a>
</span><span id="AIPlayer-318"><a href="#AIPlayer-318"><span class="linenos">318</span></a><span class="s2">        Make your choice now:</span>
</span><span id="AIPlayer-319"><a href="#AIPlayer-319"><span class="linenos">319</span></a><span class="s2">        &quot;&quot;&quot;</span>
</span><span id="AIPlayer-320"><a href="#AIPlayer-320"><span class="linenos">320</span></a>
</span><span id="AIPlayer-321"><a href="#AIPlayer-321"><span class="linenos">321</span></a>        <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AIPlayer-322"><a href="#AIPlayer-322"><span class="linenos">322</span></a>        <span class="n">last_error</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AIPlayer-323"><a href="#AIPlayer-323"><span class="linenos">323</span></a>
</span><span id="AIPlayer-324"><a href="#AIPlayer-324"><span class="linenos">324</span></a>        <span class="k">while</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">:</span>
</span><span id="AIPlayer-325"><a href="#AIPlayer-325"><span class="linenos">325</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AIPlayer-326"><a href="#AIPlayer-326"><span class="linenos">326</span></a>                <span class="c1"># Get response from Ollama with system context</span>
</span><span id="AIPlayer-327"><a href="#AIPlayer-327"><span class="linenos">327</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">ollama</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
</span><span id="AIPlayer-328"><a href="#AIPlayer-328"><span class="linenos">328</span></a>                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="AIPlayer-329"><a href="#AIPlayer-329"><span class="linenos">329</span></a>                    <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span><span id="AIPlayer-330"><a href="#AIPlayer-330"><span class="linenos">330</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">GAME_CONTEXT</span><span class="p">},</span>
</span><span id="AIPlayer-331"><a href="#AIPlayer-331"><span class="linenos">331</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
</span><span id="AIPlayer-332"><a href="#AIPlayer-332"><span class="linenos">332</span></a>                    <span class="p">],</span>
</span><span id="AIPlayer-333"><a href="#AIPlayer-333"><span class="linenos">333</span></a>                <span class="p">)</span>
</span><span id="AIPlayer-334"><a href="#AIPlayer-334"><span class="linenos">334</span></a>
</span><span id="AIPlayer-335"><a href="#AIPlayer-335"><span class="linenos">335</span></a>                <span class="c1"># Extract the chosen card index from the response</span>
</span><span id="AIPlayer-336"><a href="#AIPlayer-336"><span class="linenos">336</span></a>                <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span><span id="AIPlayer-337"><a href="#AIPlayer-337"><span class="linenos">337</span></a>                <span class="n">log_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI Response (Choose Card): </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AIPlayer-338"><a href="#AIPlayer-338"><span class="linenos">338</span></a>                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="AIPlayer-339"><a href="#AIPlayer-339"><span class="linenos">339</span></a>
</span><span id="AIPlayer-340"><a href="#AIPlayer-340"><span class="linenos">340</span></a>                <span class="k">if</span> <span class="n">response_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AIPlayer-341"><a href="#AIPlayer-341"><span class="linenos">341</span></a>                    <span class="n">choice_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Choice:\s*(\d+)&quot;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">)</span>
</span><span id="AIPlayer-342"><a href="#AIPlayer-342"><span class="linenos">342</span></a>                    <span class="k">if</span> <span class="n">choice_match</span><span class="p">:</span>
</span><span id="AIPlayer-343"><a href="#AIPlayer-343"><span class="linenos">343</span></a>                        <span class="n">card_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">choice_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="AIPlayer-344"><a href="#AIPlayer-344"><span class="linenos">344</span></a>                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">card_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">discard_pile</span><span class="p">):</span>
</span><span id="AIPlayer-345"><a href="#AIPlayer-345"><span class="linenos">345</span></a>                            <span class="k">return</span> <span class="n">discard_pile</span><span class="p">[</span><span class="n">card_index</span><span class="p">]</span>
</span><span id="AIPlayer-346"><a href="#AIPlayer-346"><span class="linenos">346</span></a>
</span><span id="AIPlayer-347"><a href="#AIPlayer-347"><span class="linenos">347</span></a>                    <span class="c1"># Fallback: Find any number in the response</span>
</span><span id="AIPlayer-348"><a href="#AIPlayer-348"><span class="linenos">348</span></a>                    <span class="n">all_numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">)</span>
</span><span id="AIPlayer-349"><a href="#AIPlayer-349"><span class="linenos">349</span></a>                    <span class="k">if</span> <span class="n">all_numbers</span><span class="p">:</span>
</span><span id="AIPlayer-350"><a href="#AIPlayer-350"><span class="linenos">350</span></a>                        <span class="n">card_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">all_numbers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="AIPlayer-351"><a href="#AIPlayer-351"><span class="linenos">351</span></a>                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">card_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">discard_pile</span><span class="p">):</span>
</span><span id="AIPlayer-352"><a href="#AIPlayer-352"><span class="linenos">352</span></a>                            <span class="k">return</span> <span class="n">discard_pile</span><span class="p">[</span><span class="n">card_index</span><span class="p">]</span>
</span><span id="AIPlayer-353"><a href="#AIPlayer-353"><span class="linenos">353</span></a>                <span class="n">log_print</span><span class="p">(</span>
</span><span id="AIPlayer-354"><a href="#AIPlayer-354"><span class="linenos">354</span></a>                    <span class="sa">f</span><span class="s2">&quot;Error: Could not extract card choice from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AIPlayer-355"><a href="#AIPlayer-355"><span class="linenos">355</span></a>                <span class="p">)</span>
</span><span id="AIPlayer-356"><a href="#AIPlayer-356"><span class="linenos">356</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to extract card choice from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AIPlayer-357"><a href="#AIPlayer-357"><span class="linenos">357</span></a>                <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AIPlayer-358"><a href="#AIPlayer-358"><span class="linenos">358</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span><span class="p">)</span>
</span><span id="AIPlayer-359"><a href="#AIPlayer-359"><span class="linenos">359</span></a>
</span><span id="AIPlayer-360"><a href="#AIPlayer-360"><span class="linenos">360</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AIPlayer-361"><a href="#AIPlayer-361"><span class="linenos">361</span></a>                <span class="n">log_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during AI card choice (discard): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AIPlayer-362"><a href="#AIPlayer-362"><span class="linenos">362</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="AIPlayer-363"><a href="#AIPlayer-363"><span class="linenos">363</span></a>                <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AIPlayer-364"><a href="#AIPlayer-364"><span class="linenos">364</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span><span class="p">)</span>
</span><span id="AIPlayer-365"><a href="#AIPlayer-365"><span class="linenos">365</span></a>
</span><span id="AIPlayer-366"><a href="#AIPlayer-366"><span class="linenos">366</span></a>        <span class="n">log_print</span><span class="p">(</span>
</span><span id="AIPlayer-367"><a href="#AIPlayer-367"><span class="linenos">367</span></a>            <span class="sa">f</span><span class="s2">&quot;All retries failed. Using first card from discard pile. Last error: </span><span class="si">{</span><span class="n">last_error</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AIPlayer-368"><a href="#AIPlayer-368"><span class="linenos">368</span></a>        <span class="p">)</span>
</span><span id="AIPlayer-369"><a href="#AIPlayer-369"><span class="linenos">369</span></a>        <span class="k">return</span> <span class="n">discard_pile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="AIPlayer-370"><a href="#AIPlayer-370"><span class="linenos">370</span></a>
</span><span id="AIPlayer-371"><a href="#AIPlayer-371"><span class="linenos">371</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">choose_two_cards_from_hand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hand</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Card</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Card</span><span class="p">]:</span>
</span><span id="AIPlayer-372"><a href="#AIPlayer-372"><span class="linenos">372</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Choose up to two cards to discard from hand when affected by a Four one-off effect.&quot;&quot;&quot;</span>
</span><span id="AIPlayer-373"><a href="#AIPlayer-373"><span class="linenos">373</span></a>        <span class="c1"># Format the prompt for the LLM</span>
</span><span id="AIPlayer-374"><a href="#AIPlayer-374"><span class="linenos">374</span></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="AIPlayer-375"><a href="#AIPlayer-375"><span class="linenos">375</span></a><span class="s2">        You need to choose up to two cards to discard from your hand. Here are the available cards:</span>
</span><span id="AIPlayer-376"><a href="#AIPlayer-376"><span class="linenos">376</span></a><span class="s2">        </span><span class="si">{</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">card</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">hand</span><span class="p">]</span><span class="si">}</span>
</span><span id="AIPlayer-377"><a href="#AIPlayer-377"><span class="linenos">377</span></a>
</span><span id="AIPlayer-378"><a href="#AIPlayer-378"><span class="linenos">378</span></a><span class="s2">        Consider these factors when choosing:</span>
</span><span id="AIPlayer-379"><a href="#AIPlayer-379"><span class="linenos">379</span></a><span class="s2">        1. Prioritize discarding low-value point cards (1-6)</span>
</span><span id="AIPlayer-380"><a href="#AIPlayer-380"><span class="linenos">380</span></a><span class="s2">        2. Avoid discarding valuable cards like:</span>
</span><span id="AIPlayer-381"><a href="#AIPlayer-381"><span class="linenos">381</span></a><span class="s2">           - High point cards (7-10)</span>
</span><span id="AIPlayer-382"><a href="#AIPlayer-382"><span class="linenos">382</span></a><span class="s2">           - Face cards (Kings, Queens, Jacks)</span>
</span><span id="AIPlayer-383"><a href="#AIPlayer-383"><span class="linenos">383</span></a><span class="s2">           - Twos (valuable for countering one-offs)</span>
</span><span id="AIPlayer-384"><a href="#AIPlayer-384"><span class="linenos">384</span></a><span class="s2">           - One-off cards (Aces, Threes, Fives, Sixes)</span>
</span><span id="AIPlayer-385"><a href="#AIPlayer-385"><span class="linenos">385</span></a><span class="s2">        3. If you have multiple low-value cards, choose the ones with the lowest point values</span>
</span><span id="AIPlayer-386"><a href="#AIPlayer-386"><span class="linenos">386</span></a>
</span><span id="AIPlayer-387"><a href="#AIPlayer-387"><span class="linenos">387</span></a><span class="s2">        Instructions:</span>
</span><span id="AIPlayer-388"><a href="#AIPlayer-388"><span class="linenos">388</span></a><span class="s2">        1. Analyze the available cards</span>
</span><span id="AIPlayer-389"><a href="#AIPlayer-389"><span class="linenos">389</span></a><span class="s2">        2. Choose up to two cards to discard based on the game rules and strategies</span>
</span><span id="AIPlayer-390"><a href="#AIPlayer-390"><span class="linenos">390</span></a><span class="s2">        3. IMPORTANT: Your response MUST be a comma-separated list of numbers from 0 to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">hand</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span>
</span><span id="AIPlayer-391"><a href="#AIPlayer-391"><span class="linenos">391</span></a><span class="s2">        4. Format your response as:</span>
</span><span id="AIPlayer-392"><a href="#AIPlayer-392"><span class="linenos">392</span></a><span class="s2">           Reasoning: [brief explanation]</span>
</span><span id="AIPlayer-393"><a href="#AIPlayer-393"><span class="linenos">393</span></a><span class="s2">           Choice: [index1, index2]</span>
</span><span id="AIPlayer-394"><a href="#AIPlayer-394"><span class="linenos">394</span></a>
</span><span id="AIPlayer-395"><a href="#AIPlayer-395"><span class="linenos">395</span></a><span class="s2">        Make your choice now:</span>
</span><span id="AIPlayer-396"><a href="#AIPlayer-396"><span class="linenos">396</span></a><span class="s2">        &quot;&quot;&quot;</span>
</span><span id="AIPlayer-397"><a href="#AIPlayer-397"><span class="linenos">397</span></a>
</span><span id="AIPlayer-398"><a href="#AIPlayer-398"><span class="linenos">398</span></a>        <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AIPlayer-399"><a href="#AIPlayer-399"><span class="linenos">399</span></a>        <span class="n">last_error</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AIPlayer-400"><a href="#AIPlayer-400"><span class="linenos">400</span></a>
</span><span id="AIPlayer-401"><a href="#AIPlayer-401"><span class="linenos">401</span></a>        <span class="k">while</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">:</span>
</span><span id="AIPlayer-402"><a href="#AIPlayer-402"><span class="linenos">402</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AIPlayer-403"><a href="#AIPlayer-403"><span class="linenos">403</span></a>                <span class="c1"># Get response from Ollama with system context</span>
</span><span id="AIPlayer-404"><a href="#AIPlayer-404"><span class="linenos">404</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">ollama</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
</span><span id="AIPlayer-405"><a href="#AIPlayer-405"><span class="linenos">405</span></a>                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="AIPlayer-406"><a href="#AIPlayer-406"><span class="linenos">406</span></a>                    <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span><span id="AIPlayer-407"><a href="#AIPlayer-407"><span class="linenos">407</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">GAME_CONTEXT</span><span class="p">},</span>
</span><span id="AIPlayer-408"><a href="#AIPlayer-408"><span class="linenos">408</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
</span><span id="AIPlayer-409"><a href="#AIPlayer-409"><span class="linenos">409</span></a>                    <span class="p">],</span>
</span><span id="AIPlayer-410"><a href="#AIPlayer-410"><span class="linenos">410</span></a>                <span class="p">)</span>
</span><span id="AIPlayer-411"><a href="#AIPlayer-411"><span class="linenos">411</span></a>
</span><span id="AIPlayer-412"><a href="#AIPlayer-412"><span class="linenos">412</span></a>                <span class="c1"># Extract the card indices from the response</span>
</span><span id="AIPlayer-413"><a href="#AIPlayer-413"><span class="linenos">413</span></a>                <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span><span id="AIPlayer-414"><a href="#AIPlayer-414"><span class="linenos">414</span></a>                <span class="n">log_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI Response (Choose Two Cards): </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AIPlayer-415"><a href="#AIPlayer-415"><span class="linenos">415</span></a>                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="AIPlayer-416"><a href="#AIPlayer-416"><span class="linenos">416</span></a>
</span><span id="AIPlayer-417"><a href="#AIPlayer-417"><span class="linenos">417</span></a>                <span class="k">if</span> <span class="n">response_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AIPlayer-418"><a href="#AIPlayer-418"><span class="linenos">418</span></a>                    <span class="n">choice_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span><span id="AIPlayer-419"><a href="#AIPlayer-419"><span class="linenos">419</span></a>                        <span class="sa">r</span><span class="s2">&quot;Choice:\s*(\d+),\s*(\d+)&quot;</span><span class="p">,</span> <span class="n">response_text</span>
</span><span id="AIPlayer-420"><a href="#AIPlayer-420"><span class="linenos">420</span></a>                    <span class="p">)</span>
</span><span id="AIPlayer-421"><a href="#AIPlayer-421"><span class="linenos">421</span></a>                    <span class="k">if</span> <span class="n">choice_match</span><span class="p">:</span>
</span><span id="AIPlayer-422"><a href="#AIPlayer-422"><span class="linenos">422</span></a>                        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">choice_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">choice_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))]</span>
</span><span id="AIPlayer-423"><a href="#AIPlayer-423"><span class="linenos">423</span></a>                        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hand</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="AIPlayer-424"><a href="#AIPlayer-424"><span class="linenos">424</span></a>                            <span class="k">return</span> <span class="p">[</span><span class="n">hand</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
</span><span id="AIPlayer-425"><a href="#AIPlayer-425"><span class="linenos">425</span></a>
</span><span id="AIPlayer-426"><a href="#AIPlayer-426"><span class="linenos">426</span></a>                    <span class="c1"># Fallback: Find all numbers and take the last two distinct ones</span>
</span><span id="AIPlayer-427"><a href="#AIPlayer-427"><span class="linenos">427</span></a>                    <span class="n">all_numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">)</span>
</span><span id="AIPlayer-428"><a href="#AIPlayer-428"><span class="linenos">428</span></a>                    <span class="n">valid_indices</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AIPlayer-429"><a href="#AIPlayer-429"><span class="linenos">429</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">all_numbers</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hand</span><span class="p">)</span>
</span><span id="AIPlayer-430"><a href="#AIPlayer-430"><span class="linenos">430</span></a>                    <span class="p">]</span>
</span><span id="AIPlayer-431"><a href="#AIPlayer-431"><span class="linenos">431</span></a>                    <span class="c1"># Get unique indices while preserving order (last occurrence)</span>
</span><span id="AIPlayer-432"><a href="#AIPlayer-432"><span class="linenos">432</span></a>                    <span class="n">unique_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="AIPlayer-433"><a href="#AIPlayer-433"><span class="linenos">433</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_indices</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="AIPlayer-434"><a href="#AIPlayer-434"><span class="linenos">434</span></a>                        <span class="n">chosen_indices</span> <span class="o">=</span> <span class="n">unique_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
</span><span id="AIPlayer-435"><a href="#AIPlayer-435"><span class="linenos">435</span></a>                        <span class="k">return</span> <span class="p">[</span><span class="n">hand</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chosen_indices</span><span class="p">]</span>
</span><span id="AIPlayer-436"><a href="#AIPlayer-436"><span class="linenos">436</span></a>
</span><span id="AIPlayer-437"><a href="#AIPlayer-437"><span class="linenos">437</span></a>                <span class="n">log_print</span><span class="p">(</span>
</span><span id="AIPlayer-438"><a href="#AIPlayer-438"><span class="linenos">438</span></a>                    <span class="sa">f</span><span class="s2">&quot;Error: Could not extract two card choices from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AIPlayer-439"><a href="#AIPlayer-439"><span class="linenos">439</span></a>                <span class="p">)</span>
</span><span id="AIPlayer-440"><a href="#AIPlayer-440"><span class="linenos">440</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to extract two card choices from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AIPlayer-441"><a href="#AIPlayer-441"><span class="linenos">441</span></a>
</span><span id="AIPlayer-442"><a href="#AIPlayer-442"><span class="linenos">442</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AIPlayer-443"><a href="#AIPlayer-443"><span class="linenos">443</span></a>                <span class="n">log_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during AI card choice (hand): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AIPlayer-444"><a href="#AIPlayer-444"><span class="linenos">444</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="AIPlayer-445"><a href="#AIPlayer-445"><span class="linenos">445</span></a>                <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AIPlayer-446"><a href="#AIPlayer-446"><span class="linenos">446</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span><span class="p">)</span>
</span><span id="AIPlayer-447"><a href="#AIPlayer-447"><span class="linenos">447</span></a>
</span><span id="AIPlayer-448"><a href="#AIPlayer-448"><span class="linenos">448</span></a>        <span class="n">log_print</span><span class="p">(</span>
</span><span id="AIPlayer-449"><a href="#AIPlayer-449"><span class="linenos">449</span></a>            <span class="sa">f</span><span class="s2">&quot;All retries failed. Using first two cards from hand. Last error: </span><span class="si">{</span><span class="n">last_error</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AIPlayer-450"><a href="#AIPlayer-450"><span class="linenos">450</span></a>        <span class="p">)</span>
</span><span id="AIPlayer-451"><a href="#AIPlayer-451"><span class="linenos">451</span></a>        <span class="c1"># Return up to 2 cards from the hand</span>
</span><span id="AIPlayer-452"><a href="#AIPlayer-452"><span class="linenos">452</span></a>        <span class="k">return</span> <span class="n">hand</span><span class="p">[:</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hand</span><span class="p">))]</span>
</span></pre></div>


            <div class="docstring"><p>AI player that uses Ollama LLM to make decisions in the game.</p>

<p>This class implements an AI player that uses a large language model (LLM)
to analyze game states and make strategic decisions. It understands game rules,
implements various strategies, and tries to avoid common mistakes.</p>

<p>The AI player can:</p>

<ul>
<li>Analyze the current game state</li>
<li>Choose optimal actions from available legal moves</li>
<li>Make strategic decisions about card usage</li>
<li>Handle special card effects and combinations</li>
</ul>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>model (str):</strong>  The Ollama model to use for decision making.</li>
<li><strong>max_retries (int):</strong>  Maximum number of retries for failed LLM calls.</li>
<li><strong>retry_delay (int):</strong>  Delay in seconds between retries.</li>
<li><strong>GAME_CONTEXT (str):</strong>  Detailed game rules and strategy guide for the LLM.</li>
</ul>
</div>


                            <div id="AIPlayer.__init__" class="classattr">
                                        <input id="AIPlayer.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">AIPlayer</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">retry_delay</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>, </span><span class="param"><span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span></span>)</span>

                <label class="view-source-button" for="AIPlayer.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AIPlayer.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AIPlayer.__init__-88"><a href="#AIPlayer.__init__-88"><span class="linenos"> 88</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retry_delay</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AIPlayer.__init__-89"><a href="#AIPlayer.__init__-89"><span class="linenos"> 89</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the AI player.</span>
</span><span id="AIPlayer.__init__-90"><a href="#AIPlayer.__init__-90"><span class="linenos"> 90</span></a>
</span><span id="AIPlayer.__init__-91"><a href="#AIPlayer.__init__-91"><span class="linenos"> 91</span></a><span class="sd">        Sets up:</span>
</span><span id="AIPlayer.__init__-92"><a href="#AIPlayer.__init__-92"><span class="linenos"> 92</span></a><span class="sd">        - The default language model (gemma3:4b)</span>
</span><span id="AIPlayer.__init__-93"><a href="#AIPlayer.__init__-93"><span class="linenos"> 93</span></a><span class="sd">        - Retry settings for LLM calls</span>
</span><span id="AIPlayer.__init__-94"><a href="#AIPlayer.__init__-94"><span class="linenos"> 94</span></a><span class="sd">        - Verifies AI&#39;s understanding of game rules</span>
</span><span id="AIPlayer.__init__-95"><a href="#AIPlayer.__init__-95"><span class="linenos"> 95</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AIPlayer.__init__-96"><a href="#AIPlayer.__init__-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;gemma3:4b&quot;</span>  <span class="c1"># Default to mistral model</span>
</span><span id="AIPlayer.__init__-97"><a href="#AIPlayer.__init__-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>
</span><span id="AIPlayer.__init__-98"><a href="#AIPlayer.__init__-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span> <span class="o">=</span> <span class="n">retry_delay</span>  <span class="c1"># seconds</span>
</span><span id="AIPlayer.__init__-99"><a href="#AIPlayer.__init__-99"><span class="linenos"> 99</span></a>
</span><span id="AIPlayer.__init__-100"><a href="#AIPlayer.__init__-100"><span class="linenos">100</span></a>        <span class="c1"># Initialize system context and verify AI understanding</span>
</span><span id="AIPlayer.__init__-101"><a href="#AIPlayer.__init__-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_ai_understanding</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the AI player.</p>

<p>Sets up:</p>

<ul>
<li>The default language model (gemma3:4b)</li>
<li>Retry settings for LLM calls</li>
<li>Verifies AI's understanding of game rules</li>
</ul>
</div>


                            </div>
                            <div id="AIPlayer.GAME_CONTEXT" class="classattr">
                                <div class="attr variable">
            <span class="name">GAME_CONTEXT</span>        =
<input id="AIPlayer.GAME_CONTEXT-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="AIPlayer.GAME_CONTEXT-view-value"></label><span class="default_value">&#34;\nYou are an expert of playing competitive card games. You excel at reasoning through the rules of the card game and making optimal decisions. You are great at identifying patterns and making strategic moves. You are playing a card game called Cuttle. Here are the key rules and strategies:\n\nRules:\n1. Win condition: Reach your point target (initial target is 21 points)\n2. Card Actions:\n    - Play as points (number cards 1-10), only Ace through Ten are counted as points. Eight played as face card is not counted as points.\n    - Play as face cards (Kings, Queens, Jacks, Eights)\n    - Play as one-off effects (Aces, Threes, Fours, Fives, Sixes)\n        - Aces clears all point cards for both players\n        - Threes let&#39;s you choose a card from the scrap pile. Avoid playing Threes as one-off when the scrap pile is empty or does not have any cards you want.\n        - Fives will let you draw the top two cards from the deck.\n        - Sixes clears all face cards for both players\n    - Scuttle: Play a higher point card to destroy opponent&#39;s point card\n    - Counter: Use a Two to counter any one-off effect\n3. Kings reduce your target score (1 King: 14, 2 Kings: 10, 3 Kings: 5, 4 Kings: 0)\n4. Face cards provide special abilities. Face cards are not counted as points.\n    - King: Reduces target score\n    - Queen: Protects your points from face cards, certain targeted one-offs, and counters. Does not protect against Ace One-offs or Six One-offs.\n    - Jack: Steals opponent&#39;s points\n    - Eight: Glasses (opponent plays with revealed hand)\n\n\nStrategies:\n1. Optimize to increase your score and decrease your target score. If you have a high value point card, try to play it as points. If a move increases your score to meet or exceed your target score, do it straight away.\n2. Prioritize playing Kings early to reduce your target score\n3. Save Twos for countering important one-off effects. Favor drawing a card over playing a two as points.\n4. Use Jacks to steal high-value point cards\n5. Protect high-value points with Queens\n6. Use Aces to clear opponent&#39;s strong point cards. Avoid playing Aces as one-off when opponent doesn&#39;t have any point cards on field. Avoid playing Aces as points when possible since the reward is low.\n7. Keep track of used Twos to know when one-offs are safe\n8. Scuttle opponent&#39;s high-value points when possible\n9. Avoid playing Six as one-off when opponent doesn&#39;t have any face cards on field.\n10. If opponent score is close to opponent&#39;s target, try to play Aces as one-off to clear their points, or play Sixes as one-off to clear their Kings if any are on field.\n\nMistakes to avoid:\n1. Playing Aces as one-off when opponent doesn&#39;t have any point cards on field.\n2. Playing Aces as points since the reward is low.\n3. Playing Threes as one-off when the scrap pile is empty or does not have any cards you want.\n4. Playing Sixes as one-off when opponent doesn&#39;t have any face cards on field.\n\nThe Strategy is key to winning the game.\n    &#34;</span>

        
    </div>
    <a class="headerlink" href="#AIPlayer.GAME_CONTEXT"></a>
    
    

                            </div>
                            <div id="AIPlayer.model" class="classattr">
                                <div class="attr variable">
            <span class="name">model</span>

        
    </div>
    <a class="headerlink" href="#AIPlayer.model"></a>
    
    

                            </div>
                            <div id="AIPlayer.max_retries" class="classattr">
                                <div class="attr variable">
            <span class="name">max_retries</span>

        
    </div>
    <a class="headerlink" href="#AIPlayer.max_retries"></a>
    
    

                            </div>
                            <div id="AIPlayer.retry_delay" class="classattr">
                                <div class="attr variable">
            <span class="name">retry_delay</span>

        
    </div>
    <a class="headerlink" href="#AIPlayer.retry_delay"></a>
    
    

                            </div>
                            <div id="AIPlayer.get_action" class="classattr">
                                        <input id="AIPlayer.get_action-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">get_action</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">game_state</span><span class="p">:</span> <span class="n"><a href="game_state.html#GameState">game.game_state.GameState</a></span>,</span><span class="param">	<span class="n">legal_actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n"><a href="action.html#Action">game.action.Action</a></span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="action.html#Action">game.action.Action</a></span>:</span></span>

                <label class="view-source-button" for="AIPlayer.get_action-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AIPlayer.get_action"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AIPlayer.get_action-200"><a href="#AIPlayer.get_action-200"><span class="linenos">200</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_action</span><span class="p">(</span>
</span><span id="AIPlayer.get_action-201"><a href="#AIPlayer.get_action-201"><span class="linenos">201</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">game_state</span><span class="p">:</span> <span class="n">GameState</span><span class="p">,</span> <span class="n">legal_actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">]</span>
</span><span id="AIPlayer.get_action-202"><a href="#AIPlayer.get_action-202"><span class="linenos">202</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Action</span><span class="p">:</span>
</span><span id="AIPlayer.get_action-203"><a href="#AIPlayer.get_action-203"><span class="linenos">203</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the AI&#39;s chosen action based on the current game state.</span>
</span><span id="AIPlayer.get_action-204"><a href="#AIPlayer.get_action-204"><span class="linenos">204</span></a>
</span><span id="AIPlayer.get_action-205"><a href="#AIPlayer.get_action-205"><span class="linenos">205</span></a><span class="sd">        This method:</span>
</span><span id="AIPlayer.get_action-206"><a href="#AIPlayer.get_action-206"><span class="linenos">206</span></a><span class="sd">        1. Validates that legal actions are available</span>
</span><span id="AIPlayer.get_action-207"><a href="#AIPlayer.get_action-207"><span class="linenos">207</span></a><span class="sd">        2. Formats the game state into a prompt</span>
</span><span id="AIPlayer.get_action-208"><a href="#AIPlayer.get_action-208"><span class="linenos">208</span></a><span class="sd">        3. Sends the prompt to the LLM</span>
</span><span id="AIPlayer.get_action-209"><a href="#AIPlayer.get_action-209"><span class="linenos">209</span></a><span class="sd">        4. Extracts and validates the chosen action</span>
</span><span id="AIPlayer.get_action-210"><a href="#AIPlayer.get_action-210"><span class="linenos">210</span></a><span class="sd">        5. Retries on failure up to max_retries times</span>
</span><span id="AIPlayer.get_action-211"><a href="#AIPlayer.get_action-211"><span class="linenos">211</span></a>
</span><span id="AIPlayer.get_action-212"><a href="#AIPlayer.get_action-212"><span class="linenos">212</span></a><span class="sd">        Args:</span>
</span><span id="AIPlayer.get_action-213"><a href="#AIPlayer.get_action-213"><span class="linenos">213</span></a><span class="sd">            game_state (GameState): The current state of the game.</span>
</span><span id="AIPlayer.get_action-214"><a href="#AIPlayer.get_action-214"><span class="linenos">214</span></a><span class="sd">            legal_actions (List[Action]): List of legal actions available.</span>
</span><span id="AIPlayer.get_action-215"><a href="#AIPlayer.get_action-215"><span class="linenos">215</span></a>
</span><span id="AIPlayer.get_action-216"><a href="#AIPlayer.get_action-216"><span class="linenos">216</span></a><span class="sd">        Returns:</span>
</span><span id="AIPlayer.get_action-217"><a href="#AIPlayer.get_action-217"><span class="linenos">217</span></a><span class="sd">            Action: The chosen action to perform.</span>
</span><span id="AIPlayer.get_action-218"><a href="#AIPlayer.get_action-218"><span class="linenos">218</span></a>
</span><span id="AIPlayer.get_action-219"><a href="#AIPlayer.get_action-219"><span class="linenos">219</span></a><span class="sd">        Raises:</span>
</span><span id="AIPlayer.get_action-220"><a href="#AIPlayer.get_action-220"><span class="linenos">220</span></a><span class="sd">            ValueError: If no legal actions are available.</span>
</span><span id="AIPlayer.get_action-221"><a href="#AIPlayer.get_action-221"><span class="linenos">221</span></a>
</span><span id="AIPlayer.get_action-222"><a href="#AIPlayer.get_action-222"><span class="linenos">222</span></a><span class="sd">        Note:</span>
</span><span id="AIPlayer.get_action-223"><a href="#AIPlayer.get_action-223"><span class="linenos">223</span></a><span class="sd">            If all retries fail, returns the first legal action as a fallback.</span>
</span><span id="AIPlayer.get_action-224"><a href="#AIPlayer.get_action-224"><span class="linenos">224</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AIPlayer.get_action-225"><a href="#AIPlayer.get_action-225"><span class="linenos">225</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">legal_actions</span><span class="p">:</span>
</span><span id="AIPlayer.get_action-226"><a href="#AIPlayer.get_action-226"><span class="linenos">226</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No legal actions available&quot;</span><span class="p">)</span>
</span><span id="AIPlayer.get_action-227"><a href="#AIPlayer.get_action-227"><span class="linenos">227</span></a>
</span><span id="AIPlayer.get_action-228"><a href="#AIPlayer.get_action-228"><span class="linenos">228</span></a>        <span class="c1"># Format the game state and actions into a prompt using the moved method</span>
</span><span id="AIPlayer.get_action-229"><a href="#AIPlayer.get_action-229"><span class="linenos">229</span></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_game_state</span><span class="p">(</span><span class="n">game_state</span><span class="p">,</span> <span class="n">legal_actions</span><span class="p">)</span>
</span><span id="AIPlayer.get_action-230"><a href="#AIPlayer.get_action-230"><span class="linenos">230</span></a>        <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AIPlayer.get_action-231"><a href="#AIPlayer.get_action-231"><span class="linenos">231</span></a>        <span class="n">last_error</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AIPlayer.get_action-232"><a href="#AIPlayer.get_action-232"><span class="linenos">232</span></a>
</span><span id="AIPlayer.get_action-233"><a href="#AIPlayer.get_action-233"><span class="linenos">233</span></a>        <span class="k">while</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">:</span>
</span><span id="AIPlayer.get_action-234"><a href="#AIPlayer.get_action-234"><span class="linenos">234</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AIPlayer.get_action-235"><a href="#AIPlayer.get_action-235"><span class="linenos">235</span></a>                <span class="c1"># Get response from Ollama with system context</span>
</span><span id="AIPlayer.get_action-236"><a href="#AIPlayer.get_action-236"><span class="linenos">236</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">ollama</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
</span><span id="AIPlayer.get_action-237"><a href="#AIPlayer.get_action-237"><span class="linenos">237</span></a>                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="AIPlayer.get_action-238"><a href="#AIPlayer.get_action-238"><span class="linenos">238</span></a>                    <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span><span id="AIPlayer.get_action-239"><a href="#AIPlayer.get_action-239"><span class="linenos">239</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">GAME_CONTEXT</span><span class="p">},</span>
</span><span id="AIPlayer.get_action-240"><a href="#AIPlayer.get_action-240"><span class="linenos">240</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
</span><span id="AIPlayer.get_action-241"><a href="#AIPlayer.get_action-241"><span class="linenos">241</span></a>                    <span class="p">],</span>
</span><span id="AIPlayer.get_action-242"><a href="#AIPlayer.get_action-242"><span class="linenos">242</span></a>                <span class="p">)</span>
</span><span id="AIPlayer.get_action-243"><a href="#AIPlayer.get_action-243"><span class="linenos">243</span></a>
</span><span id="AIPlayer.get_action-244"><a href="#AIPlayer.get_action-244"><span class="linenos">244</span></a>                <span class="c1"># Extract the action number from the response</span>
</span><span id="AIPlayer.get_action-245"><a href="#AIPlayer.get_action-245"><span class="linenos">245</span></a>                <span class="n">response_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># Default to empty string</span>
</span><span id="AIPlayer.get_action-246"><a href="#AIPlayer.get_action-246"><span class="linenos">246</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="AIPlayer.get_action-247"><a href="#AIPlayer.get_action-247"><span class="linenos">247</span></a>                    <span class="c1"># Handle real response (dictionary)</span>
</span><span id="AIPlayer.get_action-248"><a href="#AIPlayer.get_action-248"><span class="linenos">248</span></a>                    <span class="k">if</span> <span class="s1">&#39;message&#39;</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="s1">&#39;content&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]:</span>
</span><span id="AIPlayer.get_action-249"><a href="#AIPlayer.get_action-249"><span class="linenos">249</span></a>                        <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">][</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
</span><span id="AIPlayer.get_action-250"><a href="#AIPlayer.get_action-250"><span class="linenos">250</span></a>                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">):</span>
</span><span id="AIPlayer.get_action-251"><a href="#AIPlayer.get_action-251"><span class="linenos">251</span></a>                    <span class="c1"># Handle MagicMock response (attribute access)</span>
</span><span id="AIPlayer.get_action-252"><a href="#AIPlayer.get_action-252"><span class="linenos">252</span></a>                    <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span><span id="AIPlayer.get_action-253"><a href="#AIPlayer.get_action-253"><span class="linenos">253</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AIPlayer.get_action-254"><a href="#AIPlayer.get_action-254"><span class="linenos">254</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Unexpected response structure: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AIPlayer.get_action-255"><a href="#AIPlayer.get_action-255"><span class="linenos">255</span></a>                    <span class="c1"># Fallback or raise error if needed, for now rely on parsing logic below to handle empty/bad string</span>
</span><span id="AIPlayer.get_action-256"><a href="#AIPlayer.get_action-256"><span class="linenos">256</span></a>
</span><span id="AIPlayer.get_action-257"><a href="#AIPlayer.get_action-257"><span class="linenos">257</span></a>                <span class="c1"># log_print(f&quot;AI Response Content: {response_text}&quot;) # Use standard print for debugging</span>
</span><span id="AIPlayer.get_action-258"><a href="#AIPlayer.get_action-258"><span class="linenos">258</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI Response Content: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AIPlayer.get_action-259"><a href="#AIPlayer.get_action-259"><span class="linenos">259</span></a>                <span class="c1"># Look for &quot;Choice: [number]&quot; pattern first</span>
</span><span id="AIPlayer.get_action-260"><a href="#AIPlayer.get_action-260"><span class="linenos">260</span></a>                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="AIPlayer.get_action-261"><a href="#AIPlayer.get_action-261"><span class="linenos">261</span></a>
</span><span id="AIPlayer.get_action-262"><a href="#AIPlayer.get_action-262"><span class="linenos">262</span></a>                <span class="k">if</span> <span class="n">response_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AIPlayer.get_action-263"><a href="#AIPlayer.get_action-263"><span class="linenos">263</span></a>                    <span class="n">choice_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Choice:\s*(\d+)&quot;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">)</span>
</span><span id="AIPlayer.get_action-264"><a href="#AIPlayer.get_action-264"><span class="linenos">264</span></a>                    <span class="k">if</span> <span class="n">choice_match</span><span class="p">:</span>
</span><span id="AIPlayer.get_action-265"><a href="#AIPlayer.get_action-265"><span class="linenos">265</span></a>                        <span class="n">action_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">choice_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="AIPlayer.get_action-266"><a href="#AIPlayer.get_action-266"><span class="linenos">266</span></a>                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">action_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">legal_actions</span><span class="p">):</span>
</span><span id="AIPlayer.get_action-267"><a href="#AIPlayer.get_action-267"><span class="linenos">267</span></a>                            <span class="k">return</span> <span class="n">legal_actions</span><span class="p">[</span><span class="n">action_index</span><span class="p">]</span>
</span><span id="AIPlayer.get_action-268"><a href="#AIPlayer.get_action-268"><span class="linenos">268</span></a>
</span><span id="AIPlayer.get_action-269"><a href="#AIPlayer.get_action-269"><span class="linenos">269</span></a>                    <span class="c1"># Fallback: Find any number in the response</span>
</span><span id="AIPlayer.get_action-270"><a href="#AIPlayer.get_action-270"><span class="linenos">270</span></a>                    <span class="n">all_numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">)</span>
</span><span id="AIPlayer.get_action-271"><a href="#AIPlayer.get_action-271"><span class="linenos">271</span></a>                    <span class="k">if</span> <span class="n">all_numbers</span><span class="p">:</span>
</span><span id="AIPlayer.get_action-272"><a href="#AIPlayer.get_action-272"><span class="linenos">272</span></a>                        <span class="n">action_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">all_numbers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Assume last number is choice</span>
</span><span id="AIPlayer.get_action-273"><a href="#AIPlayer.get_action-273"><span class="linenos">273</span></a>                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">action_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">legal_actions</span><span class="p">):</span>
</span><span id="AIPlayer.get_action-274"><a href="#AIPlayer.get_action-274"><span class="linenos">274</span></a>                            <span class="k">return</span> <span class="n">legal_actions</span><span class="p">[</span><span class="n">action_index</span><span class="p">]</span>
</span><span id="AIPlayer.get_action-275"><a href="#AIPlayer.get_action-275"><span class="linenos">275</span></a>
</span><span id="AIPlayer.get_action-276"><a href="#AIPlayer.get_action-276"><span class="linenos">276</span></a>                <span class="c1"># If extraction fails, log error and increment retries</span>
</span><span id="AIPlayer.get_action-277"><a href="#AIPlayer.get_action-277"><span class="linenos">277</span></a>                <span class="n">log_print</span><span class="p">(</span>
</span><span id="AIPlayer.get_action-278"><a href="#AIPlayer.get_action-278"><span class="linenos">278</span></a>                    <span class="sa">f</span><span class="s2">&quot;Error: Could not extract action number from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AIPlayer.get_action-279"><a href="#AIPlayer.get_action-279"><span class="linenos">279</span></a>                <span class="p">)</span>
</span><span id="AIPlayer.get_action-280"><a href="#AIPlayer.get_action-280"><span class="linenos">280</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to extract action number from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AIPlayer.get_action-281"><a href="#AIPlayer.get_action-281"><span class="linenos">281</span></a>                <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AIPlayer.get_action-282"><a href="#AIPlayer.get_action-282"><span class="linenos">282</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span><span class="p">)</span>
</span><span id="AIPlayer.get_action-283"><a href="#AIPlayer.get_action-283"><span class="linenos">283</span></a>
</span><span id="AIPlayer.get_action-284"><a href="#AIPlayer.get_action-284"><span class="linenos">284</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AIPlayer.get_action-285"><a href="#AIPlayer.get_action-285"><span class="linenos">285</span></a>                <span class="n">log_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during AI action selection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AIPlayer.get_action-286"><a href="#AIPlayer.get_action-286"><span class="linenos">286</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># Store the error message</span>
</span><span id="AIPlayer.get_action-287"><a href="#AIPlayer.get_action-287"><span class="linenos">287</span></a>                <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AIPlayer.get_action-288"><a href="#AIPlayer.get_action-288"><span class="linenos">288</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span><span class="p">)</span>
</span><span id="AIPlayer.get_action-289"><a href="#AIPlayer.get_action-289"><span class="linenos">289</span></a>
</span><span id="AIPlayer.get_action-290"><a href="#AIPlayer.get_action-290"><span class="linenos">290</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI failed to choose an action after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> retries. Error: </span><span class="si">{</span><span class="n">last_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AIPlayer.get_action-291"><a href="#AIPlayer.get_action-291"><span class="linenos">291</span></a>        <span class="k">return</span> <span class="n">legal_actions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Get the AI's chosen action based on the current game state.</p>

<p>This method:</p>

<ol>
<li>Validates that legal actions are available</li>
<li>Formats the game state into a prompt</li>
<li>Sends the prompt to the LLM</li>
<li>Extracts and validates the chosen action</li>
<li>Retries on failure up to max_retries times</li>
</ol>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>game_state (GameState):</strong>  The current state of the game.</li>
<li><strong>legal_actions (List[Action]):</strong>  List of legal actions available.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Action: The chosen action to perform.</p>
</blockquote>

<h6 id="raises">Raises:</h6>

<ul>
<li><strong>ValueError:</strong>  If no legal actions are available.</li>
</ul>

<h6 id="note">Note:</h6>

<blockquote>
  <p>If all retries fail, returns the first legal action as a fallback.</p>
</blockquote>
</div>


                            </div>
                            <div id="AIPlayer.set_model" class="classattr">
                                        <input id="AIPlayer.set_model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_model</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">model</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="AIPlayer.set_model-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AIPlayer.set_model"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AIPlayer.set_model-293"><a href="#AIPlayer.set_model-293"><span class="linenos">293</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AIPlayer.set_model-294"><a href="#AIPlayer.set_model-294"><span class="linenos">294</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the language model used by the AI player.&quot;&quot;&quot;</span>
</span><span id="AIPlayer.set_model-295"><a href="#AIPlayer.set_model-295"><span class="linenos">295</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span></pre></div>


            <div class="docstring"><p>Set the language model used by the AI player.</p>
</div>


                            </div>
                            <div id="AIPlayer.choose_card_from_discard" class="classattr">
                                        <input id="AIPlayer.choose_card_from_discard-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">choose_card_from_discard</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">discard_pile</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n"><a href="card.html#Card">game.card.Card</a></span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="card.html#Card">game.card.Card</a></span>:</span></span>

                <label class="view-source-button" for="AIPlayer.choose_card_from_discard-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AIPlayer.choose_card_from_discard"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AIPlayer.choose_card_from_discard-297"><a href="#AIPlayer.choose_card_from_discard-297"><span class="linenos">297</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">choose_card_from_discard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discard_pile</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Card</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Card</span><span class="p">:</span>
</span><span id="AIPlayer.choose_card_from_discard-298"><a href="#AIPlayer.choose_card_from_discard-298"><span class="linenos">298</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Choose a card from the discard pile when playing a Three.&quot;&quot;&quot;</span>
</span><span id="AIPlayer.choose_card_from_discard-299"><a href="#AIPlayer.choose_card_from_discard-299"><span class="linenos">299</span></a>        <span class="c1"># Format the prompt for the LLM</span>
</span><span id="AIPlayer.choose_card_from_discard-300"><a href="#AIPlayer.choose_card_from_discard-300"><span class="linenos">300</span></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="AIPlayer.choose_card_from_discard-301"><a href="#AIPlayer.choose_card_from_discard-301"><span class="linenos">301</span></a><span class="s2">        You need to choose a card from the discard pile. Here are the available cards:</span>
</span><span id="AIPlayer.choose_card_from_discard-302"><a href="#AIPlayer.choose_card_from_discard-302"><span class="linenos">302</span></a><span class="s2">        </span><span class="si">{</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">card</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">discard_pile</span><span class="p">]</span><span class="si">}</span>
</span><span id="AIPlayer.choose_card_from_discard-303"><a href="#AIPlayer.choose_card_from_discard-303"><span class="linenos">303</span></a>
</span><span id="AIPlayer.choose_card_from_discard-304"><a href="#AIPlayer.choose_card_from_discard-304"><span class="linenos">304</span></a><span class="s2">        Consider these factors when choosing:</span>
</span><span id="AIPlayer.choose_card_from_discard-305"><a href="#AIPlayer.choose_card_from_discard-305"><span class="linenos">305</span></a><span class="s2">        1. High point cards (7-10) are valuable for scoring</span>
</span><span id="AIPlayer.choose_card_from_discard-306"><a href="#AIPlayer.choose_card_from_discard-306"><span class="linenos">306</span></a><span class="s2">        2. Face cards (Kings, Queens, Jacks) provide powerful effects</span>
</span><span id="AIPlayer.choose_card_from_discard-307"><a href="#AIPlayer.choose_card_from_discard-307"><span class="linenos">307</span></a><span class="s2">        3. Twos are valuable for countering one-offs</span>
</span><span id="AIPlayer.choose_card_from_discard-308"><a href="#AIPlayer.choose_card_from_discard-308"><span class="linenos">308</span></a><span class="s2">        4. One-off cards (Aces, Threes, Fives, Sixes) can be useful for special effects</span>
</span><span id="AIPlayer.choose_card_from_discard-309"><a href="#AIPlayer.choose_card_from_discard-309"><span class="linenos">309</span></a>
</span><span id="AIPlayer.choose_card_from_discard-310"><a href="#AIPlayer.choose_card_from_discard-310"><span class="linenos">310</span></a><span class="s2">        Instructions:</span>
</span><span id="AIPlayer.choose_card_from_discard-311"><a href="#AIPlayer.choose_card_from_discard-311"><span class="linenos">311</span></a><span class="s2">        1. Analyze the available cards</span>
</span><span id="AIPlayer.choose_card_from_discard-312"><a href="#AIPlayer.choose_card_from_discard-312"><span class="linenos">312</span></a><span class="s2">        2. Choose the most valuable card based on the game rules and strategies</span>
</span><span id="AIPlayer.choose_card_from_discard-313"><a href="#AIPlayer.choose_card_from_discard-313"><span class="linenos">313</span></a><span class="s2">        3. IMPORTANT: Your response MUST be a number from 0 to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">discard_pile</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span>
</span><span id="AIPlayer.choose_card_from_discard-314"><a href="#AIPlayer.choose_card_from_discard-314"><span class="linenos">314</span></a><span class="s2">        4. Format your response as:</span>
</span><span id="AIPlayer.choose_card_from_discard-315"><a href="#AIPlayer.choose_card_from_discard-315"><span class="linenos">315</span></a><span class="s2">           Reasoning: [brief explanation]</span>
</span><span id="AIPlayer.choose_card_from_discard-316"><a href="#AIPlayer.choose_card_from_discard-316"><span class="linenos">316</span></a><span class="s2">           Choice: [index number]</span>
</span><span id="AIPlayer.choose_card_from_discard-317"><a href="#AIPlayer.choose_card_from_discard-317"><span class="linenos">317</span></a>
</span><span id="AIPlayer.choose_card_from_discard-318"><a href="#AIPlayer.choose_card_from_discard-318"><span class="linenos">318</span></a><span class="s2">        Make your choice now:</span>
</span><span id="AIPlayer.choose_card_from_discard-319"><a href="#AIPlayer.choose_card_from_discard-319"><span class="linenos">319</span></a><span class="s2">        &quot;&quot;&quot;</span>
</span><span id="AIPlayer.choose_card_from_discard-320"><a href="#AIPlayer.choose_card_from_discard-320"><span class="linenos">320</span></a>
</span><span id="AIPlayer.choose_card_from_discard-321"><a href="#AIPlayer.choose_card_from_discard-321"><span class="linenos">321</span></a>        <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AIPlayer.choose_card_from_discard-322"><a href="#AIPlayer.choose_card_from_discard-322"><span class="linenos">322</span></a>        <span class="n">last_error</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AIPlayer.choose_card_from_discard-323"><a href="#AIPlayer.choose_card_from_discard-323"><span class="linenos">323</span></a>
</span><span id="AIPlayer.choose_card_from_discard-324"><a href="#AIPlayer.choose_card_from_discard-324"><span class="linenos">324</span></a>        <span class="k">while</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">:</span>
</span><span id="AIPlayer.choose_card_from_discard-325"><a href="#AIPlayer.choose_card_from_discard-325"><span class="linenos">325</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AIPlayer.choose_card_from_discard-326"><a href="#AIPlayer.choose_card_from_discard-326"><span class="linenos">326</span></a>                <span class="c1"># Get response from Ollama with system context</span>
</span><span id="AIPlayer.choose_card_from_discard-327"><a href="#AIPlayer.choose_card_from_discard-327"><span class="linenos">327</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">ollama</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
</span><span id="AIPlayer.choose_card_from_discard-328"><a href="#AIPlayer.choose_card_from_discard-328"><span class="linenos">328</span></a>                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="AIPlayer.choose_card_from_discard-329"><a href="#AIPlayer.choose_card_from_discard-329"><span class="linenos">329</span></a>                    <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span><span id="AIPlayer.choose_card_from_discard-330"><a href="#AIPlayer.choose_card_from_discard-330"><span class="linenos">330</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">GAME_CONTEXT</span><span class="p">},</span>
</span><span id="AIPlayer.choose_card_from_discard-331"><a href="#AIPlayer.choose_card_from_discard-331"><span class="linenos">331</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
</span><span id="AIPlayer.choose_card_from_discard-332"><a href="#AIPlayer.choose_card_from_discard-332"><span class="linenos">332</span></a>                    <span class="p">],</span>
</span><span id="AIPlayer.choose_card_from_discard-333"><a href="#AIPlayer.choose_card_from_discard-333"><span class="linenos">333</span></a>                <span class="p">)</span>
</span><span id="AIPlayer.choose_card_from_discard-334"><a href="#AIPlayer.choose_card_from_discard-334"><span class="linenos">334</span></a>
</span><span id="AIPlayer.choose_card_from_discard-335"><a href="#AIPlayer.choose_card_from_discard-335"><span class="linenos">335</span></a>                <span class="c1"># Extract the chosen card index from the response</span>
</span><span id="AIPlayer.choose_card_from_discard-336"><a href="#AIPlayer.choose_card_from_discard-336"><span class="linenos">336</span></a>                <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span><span id="AIPlayer.choose_card_from_discard-337"><a href="#AIPlayer.choose_card_from_discard-337"><span class="linenos">337</span></a>                <span class="n">log_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI Response (Choose Card): </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AIPlayer.choose_card_from_discard-338"><a href="#AIPlayer.choose_card_from_discard-338"><span class="linenos">338</span></a>                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="AIPlayer.choose_card_from_discard-339"><a href="#AIPlayer.choose_card_from_discard-339"><span class="linenos">339</span></a>
</span><span id="AIPlayer.choose_card_from_discard-340"><a href="#AIPlayer.choose_card_from_discard-340"><span class="linenos">340</span></a>                <span class="k">if</span> <span class="n">response_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AIPlayer.choose_card_from_discard-341"><a href="#AIPlayer.choose_card_from_discard-341"><span class="linenos">341</span></a>                    <span class="n">choice_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Choice:\s*(\d+)&quot;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">)</span>
</span><span id="AIPlayer.choose_card_from_discard-342"><a href="#AIPlayer.choose_card_from_discard-342"><span class="linenos">342</span></a>                    <span class="k">if</span> <span class="n">choice_match</span><span class="p">:</span>
</span><span id="AIPlayer.choose_card_from_discard-343"><a href="#AIPlayer.choose_card_from_discard-343"><span class="linenos">343</span></a>                        <span class="n">card_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">choice_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="AIPlayer.choose_card_from_discard-344"><a href="#AIPlayer.choose_card_from_discard-344"><span class="linenos">344</span></a>                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">card_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">discard_pile</span><span class="p">):</span>
</span><span id="AIPlayer.choose_card_from_discard-345"><a href="#AIPlayer.choose_card_from_discard-345"><span class="linenos">345</span></a>                            <span class="k">return</span> <span class="n">discard_pile</span><span class="p">[</span><span class="n">card_index</span><span class="p">]</span>
</span><span id="AIPlayer.choose_card_from_discard-346"><a href="#AIPlayer.choose_card_from_discard-346"><span class="linenos">346</span></a>
</span><span id="AIPlayer.choose_card_from_discard-347"><a href="#AIPlayer.choose_card_from_discard-347"><span class="linenos">347</span></a>                    <span class="c1"># Fallback: Find any number in the response</span>
</span><span id="AIPlayer.choose_card_from_discard-348"><a href="#AIPlayer.choose_card_from_discard-348"><span class="linenos">348</span></a>                    <span class="n">all_numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">)</span>
</span><span id="AIPlayer.choose_card_from_discard-349"><a href="#AIPlayer.choose_card_from_discard-349"><span class="linenos">349</span></a>                    <span class="k">if</span> <span class="n">all_numbers</span><span class="p">:</span>
</span><span id="AIPlayer.choose_card_from_discard-350"><a href="#AIPlayer.choose_card_from_discard-350"><span class="linenos">350</span></a>                        <span class="n">card_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">all_numbers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="AIPlayer.choose_card_from_discard-351"><a href="#AIPlayer.choose_card_from_discard-351"><span class="linenos">351</span></a>                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">card_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">discard_pile</span><span class="p">):</span>
</span><span id="AIPlayer.choose_card_from_discard-352"><a href="#AIPlayer.choose_card_from_discard-352"><span class="linenos">352</span></a>                            <span class="k">return</span> <span class="n">discard_pile</span><span class="p">[</span><span class="n">card_index</span><span class="p">]</span>
</span><span id="AIPlayer.choose_card_from_discard-353"><a href="#AIPlayer.choose_card_from_discard-353"><span class="linenos">353</span></a>                <span class="n">log_print</span><span class="p">(</span>
</span><span id="AIPlayer.choose_card_from_discard-354"><a href="#AIPlayer.choose_card_from_discard-354"><span class="linenos">354</span></a>                    <span class="sa">f</span><span class="s2">&quot;Error: Could not extract card choice from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AIPlayer.choose_card_from_discard-355"><a href="#AIPlayer.choose_card_from_discard-355"><span class="linenos">355</span></a>                <span class="p">)</span>
</span><span id="AIPlayer.choose_card_from_discard-356"><a href="#AIPlayer.choose_card_from_discard-356"><span class="linenos">356</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to extract card choice from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AIPlayer.choose_card_from_discard-357"><a href="#AIPlayer.choose_card_from_discard-357"><span class="linenos">357</span></a>                <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AIPlayer.choose_card_from_discard-358"><a href="#AIPlayer.choose_card_from_discard-358"><span class="linenos">358</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span><span class="p">)</span>
</span><span id="AIPlayer.choose_card_from_discard-359"><a href="#AIPlayer.choose_card_from_discard-359"><span class="linenos">359</span></a>
</span><span id="AIPlayer.choose_card_from_discard-360"><a href="#AIPlayer.choose_card_from_discard-360"><span class="linenos">360</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AIPlayer.choose_card_from_discard-361"><a href="#AIPlayer.choose_card_from_discard-361"><span class="linenos">361</span></a>                <span class="n">log_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during AI card choice (discard): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AIPlayer.choose_card_from_discard-362"><a href="#AIPlayer.choose_card_from_discard-362"><span class="linenos">362</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="AIPlayer.choose_card_from_discard-363"><a href="#AIPlayer.choose_card_from_discard-363"><span class="linenos">363</span></a>                <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AIPlayer.choose_card_from_discard-364"><a href="#AIPlayer.choose_card_from_discard-364"><span class="linenos">364</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span><span class="p">)</span>
</span><span id="AIPlayer.choose_card_from_discard-365"><a href="#AIPlayer.choose_card_from_discard-365"><span class="linenos">365</span></a>
</span><span id="AIPlayer.choose_card_from_discard-366"><a href="#AIPlayer.choose_card_from_discard-366"><span class="linenos">366</span></a>        <span class="n">log_print</span><span class="p">(</span>
</span><span id="AIPlayer.choose_card_from_discard-367"><a href="#AIPlayer.choose_card_from_discard-367"><span class="linenos">367</span></a>            <span class="sa">f</span><span class="s2">&quot;All retries failed. Using first card from discard pile. Last error: </span><span class="si">{</span><span class="n">last_error</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AIPlayer.choose_card_from_discard-368"><a href="#AIPlayer.choose_card_from_discard-368"><span class="linenos">368</span></a>        <span class="p">)</span>
</span><span id="AIPlayer.choose_card_from_discard-369"><a href="#AIPlayer.choose_card_from_discard-369"><span class="linenos">369</span></a>        <span class="k">return</span> <span class="n">discard_pile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Choose a card from the discard pile when playing a Three.</p>
</div>


                            </div>
                            <div id="AIPlayer.choose_two_cards_from_hand" class="classattr">
                                        <input id="AIPlayer.choose_two_cards_from_hand-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">choose_two_cards_from_hand</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">hand</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n"><a href="card.html#Card">game.card.Card</a></span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n"><a href="card.html#Card">game.card.Card</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="AIPlayer.choose_two_cards_from_hand-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AIPlayer.choose_two_cards_from_hand"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AIPlayer.choose_two_cards_from_hand-371"><a href="#AIPlayer.choose_two_cards_from_hand-371"><span class="linenos">371</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">choose_two_cards_from_hand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hand</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Card</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Card</span><span class="p">]:</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-372"><a href="#AIPlayer.choose_two_cards_from_hand-372"><span class="linenos">372</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Choose up to two cards to discard from hand when affected by a Four one-off effect.&quot;&quot;&quot;</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-373"><a href="#AIPlayer.choose_two_cards_from_hand-373"><span class="linenos">373</span></a>        <span class="c1"># Format the prompt for the LLM</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-374"><a href="#AIPlayer.choose_two_cards_from_hand-374"><span class="linenos">374</span></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-375"><a href="#AIPlayer.choose_two_cards_from_hand-375"><span class="linenos">375</span></a><span class="s2">        You need to choose up to two cards to discard from your hand. Here are the available cards:</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-376"><a href="#AIPlayer.choose_two_cards_from_hand-376"><span class="linenos">376</span></a><span class="s2">        </span><span class="si">{</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">card</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">hand</span><span class="p">]</span><span class="si">}</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-377"><a href="#AIPlayer.choose_two_cards_from_hand-377"><span class="linenos">377</span></a>
</span><span id="AIPlayer.choose_two_cards_from_hand-378"><a href="#AIPlayer.choose_two_cards_from_hand-378"><span class="linenos">378</span></a><span class="s2">        Consider these factors when choosing:</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-379"><a href="#AIPlayer.choose_two_cards_from_hand-379"><span class="linenos">379</span></a><span class="s2">        1. Prioritize discarding low-value point cards (1-6)</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-380"><a href="#AIPlayer.choose_two_cards_from_hand-380"><span class="linenos">380</span></a><span class="s2">        2. Avoid discarding valuable cards like:</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-381"><a href="#AIPlayer.choose_two_cards_from_hand-381"><span class="linenos">381</span></a><span class="s2">           - High point cards (7-10)</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-382"><a href="#AIPlayer.choose_two_cards_from_hand-382"><span class="linenos">382</span></a><span class="s2">           - Face cards (Kings, Queens, Jacks)</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-383"><a href="#AIPlayer.choose_two_cards_from_hand-383"><span class="linenos">383</span></a><span class="s2">           - Twos (valuable for countering one-offs)</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-384"><a href="#AIPlayer.choose_two_cards_from_hand-384"><span class="linenos">384</span></a><span class="s2">           - One-off cards (Aces, Threes, Fives, Sixes)</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-385"><a href="#AIPlayer.choose_two_cards_from_hand-385"><span class="linenos">385</span></a><span class="s2">        3. If you have multiple low-value cards, choose the ones with the lowest point values</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-386"><a href="#AIPlayer.choose_two_cards_from_hand-386"><span class="linenos">386</span></a>
</span><span id="AIPlayer.choose_two_cards_from_hand-387"><a href="#AIPlayer.choose_two_cards_from_hand-387"><span class="linenos">387</span></a><span class="s2">        Instructions:</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-388"><a href="#AIPlayer.choose_two_cards_from_hand-388"><span class="linenos">388</span></a><span class="s2">        1. Analyze the available cards</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-389"><a href="#AIPlayer.choose_two_cards_from_hand-389"><span class="linenos">389</span></a><span class="s2">        2. Choose up to two cards to discard based on the game rules and strategies</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-390"><a href="#AIPlayer.choose_two_cards_from_hand-390"><span class="linenos">390</span></a><span class="s2">        3. IMPORTANT: Your response MUST be a comma-separated list of numbers from 0 to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">hand</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-391"><a href="#AIPlayer.choose_two_cards_from_hand-391"><span class="linenos">391</span></a><span class="s2">        4. Format your response as:</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-392"><a href="#AIPlayer.choose_two_cards_from_hand-392"><span class="linenos">392</span></a><span class="s2">           Reasoning: [brief explanation]</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-393"><a href="#AIPlayer.choose_two_cards_from_hand-393"><span class="linenos">393</span></a><span class="s2">           Choice: [index1, index2]</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-394"><a href="#AIPlayer.choose_two_cards_from_hand-394"><span class="linenos">394</span></a>
</span><span id="AIPlayer.choose_two_cards_from_hand-395"><a href="#AIPlayer.choose_two_cards_from_hand-395"><span class="linenos">395</span></a><span class="s2">        Make your choice now:</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-396"><a href="#AIPlayer.choose_two_cards_from_hand-396"><span class="linenos">396</span></a><span class="s2">        &quot;&quot;&quot;</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-397"><a href="#AIPlayer.choose_two_cards_from_hand-397"><span class="linenos">397</span></a>
</span><span id="AIPlayer.choose_two_cards_from_hand-398"><a href="#AIPlayer.choose_two_cards_from_hand-398"><span class="linenos">398</span></a>        <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-399"><a href="#AIPlayer.choose_two_cards_from_hand-399"><span class="linenos">399</span></a>        <span class="n">last_error</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-400"><a href="#AIPlayer.choose_two_cards_from_hand-400"><span class="linenos">400</span></a>
</span><span id="AIPlayer.choose_two_cards_from_hand-401"><a href="#AIPlayer.choose_two_cards_from_hand-401"><span class="linenos">401</span></a>        <span class="k">while</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">:</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-402"><a href="#AIPlayer.choose_two_cards_from_hand-402"><span class="linenos">402</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-403"><a href="#AIPlayer.choose_two_cards_from_hand-403"><span class="linenos">403</span></a>                <span class="c1"># Get response from Ollama with system context</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-404"><a href="#AIPlayer.choose_two_cards_from_hand-404"><span class="linenos">404</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">ollama</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-405"><a href="#AIPlayer.choose_two_cards_from_hand-405"><span class="linenos">405</span></a>                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-406"><a href="#AIPlayer.choose_two_cards_from_hand-406"><span class="linenos">406</span></a>                    <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-407"><a href="#AIPlayer.choose_two_cards_from_hand-407"><span class="linenos">407</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">GAME_CONTEXT</span><span class="p">},</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-408"><a href="#AIPlayer.choose_two_cards_from_hand-408"><span class="linenos">408</span></a>                        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-409"><a href="#AIPlayer.choose_two_cards_from_hand-409"><span class="linenos">409</span></a>                    <span class="p">],</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-410"><a href="#AIPlayer.choose_two_cards_from_hand-410"><span class="linenos">410</span></a>                <span class="p">)</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-411"><a href="#AIPlayer.choose_two_cards_from_hand-411"><span class="linenos">411</span></a>
</span><span id="AIPlayer.choose_two_cards_from_hand-412"><a href="#AIPlayer.choose_two_cards_from_hand-412"><span class="linenos">412</span></a>                <span class="c1"># Extract the card indices from the response</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-413"><a href="#AIPlayer.choose_two_cards_from_hand-413"><span class="linenos">413</span></a>                <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-414"><a href="#AIPlayer.choose_two_cards_from_hand-414"><span class="linenos">414</span></a>                <span class="n">log_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AI Response (Choose Two Cards): </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-415"><a href="#AIPlayer.choose_two_cards_from_hand-415"><span class="linenos">415</span></a>                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-416"><a href="#AIPlayer.choose_two_cards_from_hand-416"><span class="linenos">416</span></a>
</span><span id="AIPlayer.choose_two_cards_from_hand-417"><a href="#AIPlayer.choose_two_cards_from_hand-417"><span class="linenos">417</span></a>                <span class="k">if</span> <span class="n">response_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-418"><a href="#AIPlayer.choose_two_cards_from_hand-418"><span class="linenos">418</span></a>                    <span class="n">choice_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-419"><a href="#AIPlayer.choose_two_cards_from_hand-419"><span class="linenos">419</span></a>                        <span class="sa">r</span><span class="s2">&quot;Choice:\s*(\d+),\s*(\d+)&quot;</span><span class="p">,</span> <span class="n">response_text</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-420"><a href="#AIPlayer.choose_two_cards_from_hand-420"><span class="linenos">420</span></a>                    <span class="p">)</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-421"><a href="#AIPlayer.choose_two_cards_from_hand-421"><span class="linenos">421</span></a>                    <span class="k">if</span> <span class="n">choice_match</span><span class="p">:</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-422"><a href="#AIPlayer.choose_two_cards_from_hand-422"><span class="linenos">422</span></a>                        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">choice_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">choice_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))]</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-423"><a href="#AIPlayer.choose_two_cards_from_hand-423"><span class="linenos">423</span></a>                        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hand</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-424"><a href="#AIPlayer.choose_two_cards_from_hand-424"><span class="linenos">424</span></a>                            <span class="k">return</span> <span class="p">[</span><span class="n">hand</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-425"><a href="#AIPlayer.choose_two_cards_from_hand-425"><span class="linenos">425</span></a>
</span><span id="AIPlayer.choose_two_cards_from_hand-426"><a href="#AIPlayer.choose_two_cards_from_hand-426"><span class="linenos">426</span></a>                    <span class="c1"># Fallback: Find all numbers and take the last two distinct ones</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-427"><a href="#AIPlayer.choose_two_cards_from_hand-427"><span class="linenos">427</span></a>                    <span class="n">all_numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">)</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-428"><a href="#AIPlayer.choose_two_cards_from_hand-428"><span class="linenos">428</span></a>                    <span class="n">valid_indices</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-429"><a href="#AIPlayer.choose_two_cards_from_hand-429"><span class="linenos">429</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">all_numbers</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hand</span><span class="p">)</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-430"><a href="#AIPlayer.choose_two_cards_from_hand-430"><span class="linenos">430</span></a>                    <span class="p">]</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-431"><a href="#AIPlayer.choose_two_cards_from_hand-431"><span class="linenos">431</span></a>                    <span class="c1"># Get unique indices while preserving order (last occurrence)</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-432"><a href="#AIPlayer.choose_two_cards_from_hand-432"><span class="linenos">432</span></a>                    <span class="n">unique_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-433"><a href="#AIPlayer.choose_two_cards_from_hand-433"><span class="linenos">433</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_indices</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-434"><a href="#AIPlayer.choose_two_cards_from_hand-434"><span class="linenos">434</span></a>                        <span class="n">chosen_indices</span> <span class="o">=</span> <span class="n">unique_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-435"><a href="#AIPlayer.choose_two_cards_from_hand-435"><span class="linenos">435</span></a>                        <span class="k">return</span> <span class="p">[</span><span class="n">hand</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chosen_indices</span><span class="p">]</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-436"><a href="#AIPlayer.choose_two_cards_from_hand-436"><span class="linenos">436</span></a>
</span><span id="AIPlayer.choose_two_cards_from_hand-437"><a href="#AIPlayer.choose_two_cards_from_hand-437"><span class="linenos">437</span></a>                <span class="n">log_print</span><span class="p">(</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-438"><a href="#AIPlayer.choose_two_cards_from_hand-438"><span class="linenos">438</span></a>                    <span class="sa">f</span><span class="s2">&quot;Error: Could not extract two card choices from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-439"><a href="#AIPlayer.choose_two_cards_from_hand-439"><span class="linenos">439</span></a>                <span class="p">)</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-440"><a href="#AIPlayer.choose_two_cards_from_hand-440"><span class="linenos">440</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to extract two card choices from response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-441"><a href="#AIPlayer.choose_two_cards_from_hand-441"><span class="linenos">441</span></a>
</span><span id="AIPlayer.choose_two_cards_from_hand-442"><a href="#AIPlayer.choose_two_cards_from_hand-442"><span class="linenos">442</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-443"><a href="#AIPlayer.choose_two_cards_from_hand-443"><span class="linenos">443</span></a>                <span class="n">log_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during AI card choice (hand): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-444"><a href="#AIPlayer.choose_two_cards_from_hand-444"><span class="linenos">444</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-445"><a href="#AIPlayer.choose_two_cards_from_hand-445"><span class="linenos">445</span></a>                <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-446"><a href="#AIPlayer.choose_two_cards_from_hand-446"><span class="linenos">446</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span><span class="p">)</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-447"><a href="#AIPlayer.choose_two_cards_from_hand-447"><span class="linenos">447</span></a>
</span><span id="AIPlayer.choose_two_cards_from_hand-448"><a href="#AIPlayer.choose_two_cards_from_hand-448"><span class="linenos">448</span></a>        <span class="n">log_print</span><span class="p">(</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-449"><a href="#AIPlayer.choose_two_cards_from_hand-449"><span class="linenos">449</span></a>            <span class="sa">f</span><span class="s2">&quot;All retries failed. Using first two cards from hand. Last error: </span><span class="si">{</span><span class="n">last_error</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-450"><a href="#AIPlayer.choose_two_cards_from_hand-450"><span class="linenos">450</span></a>        <span class="p">)</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-451"><a href="#AIPlayer.choose_two_cards_from_hand-451"><span class="linenos">451</span></a>        <span class="c1"># Return up to 2 cards from the hand</span>
</span><span id="AIPlayer.choose_two_cards_from_hand-452"><a href="#AIPlayer.choose_two_cards_from_hand-452"><span class="linenos">452</span></a>        <span class="k">return</span> <span class="n">hand</span><span class="p">[:</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hand</span><span class="p">))]</span>
</span></pre></div>


            <div class="docstring"><p>Choose up to two cards to discard from hand when affected by a Four one-off effect.</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>